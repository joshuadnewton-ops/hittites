<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lord of Hattusa: Throne of the Storm God</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Title Screen */
        .title-screen {
            text-align: center;
            padding: 40px 20px;
        }

        .title-screen img {
            max-width: 600px;
            width: 90%;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .title-screen h1 {
            font-size: 3em;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 10px;
        }

        .title-screen h2 {
            font-size: 1.5em;
            color: #c0c0c0;
            margin-bottom: 40px;
            font-style: italic;
        }

        .button {
            background: linear-gradient(135deg, #d4af37 0%, #c9a226 100%);
            color: #1a1a2e;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.6);
        }

        .button:active {
            transform: translateY(0);
        }

        /* Character Selection */
        .character-selection {
            text-align: center;
        }

        .character-selection img {
            max-width: 300px;
            width: 40%;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .king-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .king-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .king-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .king-card.easy {
            border-color: #4CAF50;
        }

        .king-card.medium {
            border-color: #FFA726;
        }

        .king-card.hard {
            border-color: #E53935;
        }

        .king-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .difficulty {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .difficulty.easy { background: #4CAF50; color: white; }
        .difficulty.medium { background: #FFA726; color: white; }
        .difficulty.hard { background: #E53935; color: white; }

        /* Game Screen - Three Column Layout */
        .game-container {
            display: grid;
            grid-template-columns: 250px 1fr 220px;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .left-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .center-content {
            min-height: 100vh;
        }

        .right-sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* Time Display */
        .time-display {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .time-display .year {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .time-display .season {
            font-size: 1em;
            color: #c0c0c0;
            margin: 5px 0;
        }

        .time-display .progress {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-top: 5px;
        }

        /* Stats Display */
        .stats-container {
            margin-top: 10px;
        }

        .stat-bar {
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 0.85em;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-value {
            font-weight: bold;
        }

        .stat-progress {
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.5s ease, background-color 0.5s ease;
            border-radius: 10px;
        }

        .stat-fill.high { background: linear-gradient(90deg, #4CAF50, #66BB6A); }
        .stat-fill.medium { background: linear-gradient(90deg, #FFA726, #FFB74D); }
        .stat-fill.low { background: linear-gradient(90deg, #E53935, #EF5350); }

        /* Advisor Cards */
        .advisor-card {
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .advisor-card.loyal-100 {
            border-color: #4CAF50;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .advisor-card.loyal-75 {
            border-color: #81C784;
            box-shadow: 0 0 10px rgba(129, 199, 132, 0.3);
        }

        .advisor-card.loyal-50 {
            border-color: rgba(255,255,255,0.2);
        }

        .advisor-card.loyal-25 {
            border-color: #FFA726;
            box-shadow: 0 0 10px rgba(255, 167, 38, 0.3);
        }

        .advisor-card.loyal-10 {
            border-color: #FF6F00;
            box-shadow: 0 0 10px rgba(255, 111, 0, 0.4);
        }

        .advisor-card.loyal-0 {
            border-color: #E53935;
            box-shadow: 0 0 15px rgba(229, 57, 53, 0.5);
        }

        .advisor-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .advisor-name {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .advisor-status {
            font-size: 0.85em;
            color: #c0c0c0;
        }

        /* Event Display */
        .event-container {
            background: rgba(0,0,0,0.4);
            border: 2px solid rgba(212, 175, 55, 0.3);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .event-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .event-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .event-title {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .event-image {
            max-width: 500px;
            width: 100%;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .event-description {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 25px;
            text-align: justify;
        }

        /* Advisor Commentary */
        .commentary-container {
            margin: 25px 0;
        }

        .commentary {
            background: rgba(255,255,255,0.05);
            border-left: 4px solid;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .commentary.aggressive { border-color: #E53935; }
        .commentary.thoughtful { border-color: #9C27B0; }
        .commentary.warning { border-color: #FFA726; }
        .commentary.worried { border-color: #FDD835; }

        .commentary-header {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .commentary-text {
            font-style: italic;
            line-height: 1.5;
        }

        /* Choices */
        .choices-container {
            margin: 25px 0;
        }

        .choice-button {
            width: 100%;
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
            color: #e0e0e0;
            padding: 15px 20px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
            text-align: left;
            transition: all 0.15s ease;
        }

        .choice-button:hover:not(:disabled) {
            background: rgba(212, 175, 55, 0.4);
            transform: translateX(5px);
        }

        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Consequences */
        .consequences-container {
            background: rgba(212, 175, 55, 0.1);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            margin: 25px 0;
        }

        .consequences-title {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .consequence-text {
            font-size: 1.05em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .stat-changes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .stat-change {
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .stat-change.positive {
            background: rgba(76, 175, 80, 0.2);
            color: #81C784;
        }

        .stat-change.negative {
            background: rgba(229, 57, 53, 0.2);
            color: #EF5350;
        }

        /* Advisor Reactions */
        .advisor-reactions {
            margin: 20px 0;
        }

        .advisor-reaction {
            background: rgba(255,255,255,0.05);
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 5px;
        }

        .advisor-reaction.approve {
            border-color: #4CAF50;
        }

        .advisor-reaction.disapprove {
            border-color: #E53935;
        }

        .reaction-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Milestone Toast */
        .milestone-toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a2e;
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
            z-index: 1000;
            animation: toastSlideIn 0.5s ease, toastSlideOut 0.5s ease 2.5s;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translate(-50%, 0);
            }
            to {
                opacity: 0;
                transform: translate(-50%, -50px);
            }
        }

        /* Rumors */
        .rumors-container {
            background: rgba(138, 43, 226, 0.1);
            border: 1px solid rgba(138, 43, 226, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .rumors-title {
            font-style: italic;
            color: #c0c0c0;
            margin-bottom: 10px;
            text-align: center;
        }

        .rumor {
            font-size: 0.95em;
            line-height: 1.5;
            margin: 5px 0;
            padding-left: 15px;
            position: relative;
        }

        .rumor::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
        }

        /* Leaderboard */
        .leaderboard-table {
            width: 100%;
            margin: 30px 0;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-table th {
            background: rgba(212, 175, 55, 0.3);
            color: #ffd700;
            font-weight: bold;
        }

        .leaderboard-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .leaderboard-table .rank-1 {
            color: #ffd700;
            font-weight: bold;
        }

        .leaderboard-table .rank-2 {
            color: #c0c0c0;
            font-weight: bold;
        }

        .leaderboard-table .rank-3 {
            color: #cd7f32;
            font-weight: bold;
        }

        /* Victory Screen */
        .victory-screen {
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .victory-screen img {
            max-width: 400px;
            width: 60%;
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .victory-title {
            font-size: 2.5em;
            color: #ffd700;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .victory-narrative {
            font-size: 1.2em;
            line-height: 1.8;
            margin: 30px 0;
            text-align: justify;
        }

        .accomplishments {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
            text-align: left;
        }

        .accomplishments h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .accomplishments ul {
            list-style-position: inside;
            line-height: 1.8;
        }

        .score-breakdown {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
        }

        .score-breakdown h3 {
            color: #ffd700;
            margin-bottom: 20px;
        }

        .score-line {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
        }

        .score-line.total {
            font-size: 1.3em;
            font-weight: bold;
            background: rgba(212, 175, 55, 0.3);
            margin-top: 20px;
        }

        .high-score-celebration {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a2e;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
        }

        /* Game Over Screen */
        .game-over-screen {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .game-over-screen img {
            max-width: 500px;
            width: 80%;
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .game-over-title {
            font-size: 2.5em;
            color: #E53935;
            margin: 20px 0;
        }

        .game-over-narrative {
            font-size: 1.1em;
            line-height: 1.8;
            margin: 30px 0;
            text-align: justify;
        }

        /* Audio Toggle */
        .audio-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(212, 175, 55, 0.3);
            border: 2px solid #d4af37;
            color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .audio-toggle:hover {
            background: rgba(212, 175, 55, 0.5);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .game-container {
                grid-template-columns: 200px 1fr;
                grid-template-areas:
                    "left center"
                    "right right";
            }
            .left-sidebar { grid-area: left; }
            .center-content { grid-area: center; }
            .right-sidebar { 
                grid-area: right;
                position: relative;
                max-height: none;
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            .left-sidebar, .right-sidebar {
                position: relative;
                max-height: none;
            }
            .right-sidebar {
                grid-template-columns: repeat(2, 1fr);
            }
            .title-screen h1 {
                font-size: 2em;
            }
            .king-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.5);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(212, 175, 55, 0.7);
        }
    </style>
</head>
<body>
    <!-- Audio Toggle -->
    <button class="audio-toggle" onclick="toggleAudio()">üîá</button>

    <!-- Title Screen -->
    <div id="titleScreen" class="screen active">
        <div class="container title-screen">
            <img src="hattusa_png.png" alt="Hattusa">
            <h1>LORD OF HATTUSA</h1>
            <h2>Throne of the Storm God</h2>
            <button class="button" onclick="showScreen('characterSelection')">Choose Your King</button>
            <button class="button" onclick="showLeaderboard()">Hall of Kings</button>
        </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="leaderboardScreen" class="screen">
        <div class="container">
            <h1 style="text-align: center; color: #ffd700; margin-bottom: 30px;">Hall of Kings</h1>
            <table class="leaderboard-table" id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>King</th>
                        <th>Score</th>
                        <th>Years Ruled</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                </tbody>
            </table>
            <div style="text-align: center; margin-top: 30px;">
                <button class="button" onclick="showScreen('titleScreen')">Return to Title</button>
                <button class="button" onclick="clearLeaderboard()">Clear Leaderboard</button>
            </div>
        </div>
    </div>

    <!-- Character Selection Screen -->
    <div id="characterSelection" class="screen">
        <div class="container character-selection">
            <h1 style="color: #ffd700; margin-bottom: 20px;">Choose Your King</h1>
            <img src="hittite_king.png" alt="Hittite King">
            <div class="king-cards">
                <div class="king-card easy" onclick="selectKing('suppiluliuma')">
                    <h3>‚öîÔ∏è Suppiluliuma I</h3>
                    <div class="difficulty easy">EASY</div>
                    <p><strong>"The Conqueror"</strong></p>
                    <p>1344 BCE - Empire at zenith</p>
                    <p>Survive 22 years</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">Start with strong stats, loyal advisors, and a peaceful realm. Maintain dominance at the height of power.</p>
                </div>
                <div class="king-card medium" onclick="selectKing('mursili')">
                    <h3>üìú Mursili II</h3>
                    <div class="difficulty medium">MEDIUM</div>
                    <p><strong>"The Chronicler King"</strong></p>
                    <p>1321 BCE - Young and tested</p>
                    <p>Survive 26 years</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">Inherit your father's throne. Face rebellions and prove your worth over a long reign.</p>
                </div>
                <div class="king-card hard" onclick="selectKing('tudhaliya')">
                    <h3>üõ°Ô∏è Tudhaliya IV</h3>
                    <div class="difficulty hard">HARD</div>
                    <p><strong>"The Embattled"</strong></p>
                    <p>1237 BCE - Bronze Age Collapse</p>
                    <p>Survive 40 years</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">Empire besieged. Sea Peoples raid, trade fails, crises multiply. Survive the collapse for 40 years.</p>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="button" onclick="showScreen('titleScreen')">Back</button>
            </div>
        </div>
    </div>

    <!-- Historical Context Screen -->
    <div id="historicalContext" class="screen">
        <div class="container" style="max-width: 800px; margin: 0 auto;">
            <h1 id="contextTitle" style="color: #ffd700; text-align: center; margin-bottom: 30px;"></h1>
            <div id="contextContent" style="font-size: 1.1em; line-height: 1.8; text-align: justify; margin-bottom: 40px;"></div>
            <div style="text-align: center;">
                <button class="button" onclick="actuallyStartGame()">Begin Your Reign</button>
                <button class="button" onclick="showScreen('characterSelection')">Choose Different King</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <!-- Left Sidebar: Time and Stats -->
            <div class="left-sidebar">
                <div class="time-display" id="timeDisplay">
                    <div class="year">1344 BCE</div>
                    <div class="season">Spring</div>
                    <div class="progress">Ruled 0 years | 22 years until succession</div>
                </div>
                <div class="stats-container" id="statsContainer">
                    <!-- Stats will be dynamically generated -->
                </div>
            </div>

            <!-- Center: Event Display -->
            <div class="center-content">
                <div id="eventDisplay">
                    <!-- Events will be displayed here -->
                </div>
            </div>

            <!-- Right Sidebar: Advisors -->
            <div class="right-sidebar" id="advisorsContainer">
                <!-- Advisor cards will be dynamically generated -->
            </div>
        </div>
    </div>

    <!-- Victory Screen -->
    <div id="victoryScreen" class="screen">
        <div class="container victory-screen">
            <img src="hittite_king.png" alt="Victory">
            <h1 class="victory-title">‚ïê‚ïê‚ïê VICTORY: A PEACEFUL DEATH ‚ïê‚ïê‚ïê</h1>
            <div id="victoryContent">
                <!-- Victory content will be dynamically generated -->
            </div>
            <div style="margin-top: 40px;">
                <button class="button" onclick="location.reload()">Play Again</button>
                <button class="button" onclick="showLeaderboard()">View Hall of Kings</button>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="screen">
        <div class="container game-over-screen">
            <div id="gameOverContent">
                <!-- Game over content will be dynamically generated -->
            </div>
            <div style="margin-top: 40px;">
                <button class="button" onclick="location.reload()">Return to Title</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            selectedKing: null,
            kingName: '',
            startYear: 1344,
            currentYear: 1344,
            victoryYear: 1322,
            targetYears: 22,
            difficultyMultiplier: 1.0,
            stats: {
                treasury: 70,
                military: 75,
                popular: 65,
                noble: 60,
                religious: 60,
                resources: 65,
                egypt: 45,
                assyria: 40,
                kassite: 55
            },
            advisorLoyalty: {
                hattusili: 75,
                puduhepa: 75,
                zida: 75,
                kantuzzili: 75
            },
            advisorBetrayalWarned: {
                hattusili: false,
                puduhepa: false,
                zida: false,
                kantuzzili: false
            },
            escalations: {
                assyrian: 0,
                egyptian: 0,
                kaska: 0,
                noble: 0,
                popular: 0,
                religious: 0,
                resources_crisis: 0,
                financial: 0,
                succession: 0,
                rebellion: 0
            },
            recentEvents: [],
            queuedEvent: null,
            firstEvent: true,
            eventCount: 0,
            lastMilestones: {},
            isProcessingChoice: false
        };

        // Audio System
        let audioContext = null;
        let audioEnabled = false;
        let backgroundMusicInterval = null;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleAudio() {
            initAudio();
            audioEnabled = !audioEnabled;
            document.querySelector('.audio-toggle').textContent = audioEnabled ? 'üîä' : 'üîá';
            if (audioEnabled) {
                startBackgroundMusic();
            } else {
                stopBackgroundMusic();
            }
        }

        function playSound(type) {
            if (!audioEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'click':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.05);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'whoosh':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'approve':
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'disapprove':
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(300, audioContext.currentTime + 0.15);
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                case 'victory':
                    [400, 500, 600, 800].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(freq, audioContext.currentTime + i * 0.1);
                        gain.gain.setValueAtTime(0.1, audioContext.currentTime + i * 0.1);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.2);
                        osc.start(audioContext.currentTime + i * 0.1);
                        osc.stop(audioContext.currentTime + i * 0.1 + 0.2);
                    });
                    break;
            }
        }

        function startBackgroundMusic() {
            if (!audioEnabled || !audioContext) return;
            stopBackgroundMusic();
            
            const pentatonic = [261.63, 293.66, 329.63, 392, 440]; // C D E G A
            
            backgroundMusicInterval = setInterval(() => {
                if (!audioEnabled) return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(
                    pentatonic[Math.floor(Math.random() * pentatonic.length)],
                    audioContext.currentTime
                );
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.08, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.8);
            }, 800);
        }

        function stopBackgroundMusic() {
            if (backgroundMusicInterval) {
                clearInterval(backgroundMusicInterval);
                backgroundMusicInterval = null;
            }
        }

        // King Data
        const kingData = {
            suppiluliuma: {
                name: "Suppiluliuma I",
                title: "The Conqueror",
                startYear: 1344,
                victoryYear: 1322,
                targetYears: 22,
                difficultyMultiplier: 1.0,
                context: "The year is 1344 BCE, and you are Suppiluliuma I, Great King of Hatti, Terror of Nations, Beloved of the Storm God. Your armies have crushed Mitanni and conquered Syria. Pharaoh himself seeks your friendship. The Hittite Empire stands at its absolute zenith - never before has a king of Hattusa wielded such power.\n\nYet power is easier won than kept. Your vassals watch for weakness. Your nobles hunger for glory. The priesthood demands piety. Your treasury must fund an empire that stretches from the Aegean to the Euphrates.\n\nYou have 22 years to maintain your legacy and die peacefully. Can you keep the empire at its peak, or will it crumble under the weight of its own greatness?",
                stats: {
                    treasury: 70,
                    military: 75,
                    popular: 65,
                    noble: 60,
                    religious: 60,
                    resources: 65,
                    egypt: 45,
                    assyria: 40,
                    kassite: 55
                },
                advisorLoyalty: {
                    hattusili: 75,
                    puduhepa: 75,
                    zida: 75,
                    kantuzzili: 75
                },
                escalations: {
                    assyrian: 0,
                    egyptian: 0,
                    kaska: 0,
                    noble: 0,
                    popular: 0,
                    religious: 0,
                    resources_crisis: 0,
                    financial: 0,
                    succession: 0,
                    rebellion: 0
                },
                victoryNarrative: "In the spring of 1322 BCE, the great Suppiluliuma I, at the age of seventy-two summers, fell ill with a plague that swept through Hattusa. Despite the best efforts of the royal physicians and the fervent prayers of Puduhepa at the temple of the Storm God, the King of Kings could not be saved.\n\nAs you lay dying, you summoned your sons and advisors to your bedside. With your final breath, you named your successor and blessed the empire you had forged. The chronicles would remember you as the greatest conqueror Hatti had ever known - the king who broke Mitanni, humbled Egypt, and made the Hittite Empire the terror of all nations.\n\nYour body was burned with royal honors, your ashes placed in a golden urn beside the Storm God's temple. For generations, kings would invoke your name, saying 'In the days of Suppiluliuma the Great...' Your reign became the golden standard against which all future kings would be measured."
            },
            mursili: {
                name: "Mursili II",
                title: "The Chronicler King",
                startYear: 1321,
                victoryYear: 1295,
                targetYears: 26,
                difficultyMultiplier: 1.3,
                context: "The year is 1321 BCE. You are Mursili II, son of the great Suppiluliuma. Your father's death has unleashed chaos - rebellious vassals test your authority, enemies encircle the empire, and even the gods seem uncertain of your worth. You were not the eldest son, yet fate and your father's will have placed the crown upon your young head.\n\nThe palace whispers doubt your fitness to rule. The generals remember your father's glory and find you wanting. The priesthood watches for signs of divine favor. Your neighboring kings smell weakness and sharpen their swords.\n\nYet you are not without strengths. Your father trained you in statecraft. Your mind is sharp and your will is iron. You have 26 years to prove yourself worthy of the throne and earn your place in the chronicles.\n\nWill you match your father's legacy, or will the empire crumble under your uncertain grasp?",
                stats: {
                    treasury: 55,
                    military: 60,
                    popular: 55,
                    noble: 50,
                    religious: 55,
                    resources: 55,
                    egypt: 50,
                    assyria: 50,
                    kassite: 50
                },
                advisorLoyalty: {
                    hattusili: 65,
                    puduhepa: 70,
                    zida: 60,
                    kantuzzili: 65
                },
                escalations: {
                    assyrian: 1,
                    egyptian: 0,
                    kaska: 0,
                    noble: 1,
                    popular: 0,
                    religious: 0,
                    resources_crisis: 0,
                    financial: 0,
                    succession: 0,
                    rebellion: 0
                },
                victoryNarrative: "In the autumn of 1295 BCE, Mursili II, at the venerable age of seventy-nine, died peacefully in his sleep, surrounded by his sons and daughters. The chronicler king had outlived most of his contemporaries and seen his grandchildren grow to adulthood.\n\nYour reign was marked not just by military victories, but by your meticulous records of your deeds. The clay tablets you ordered written - the famous 'Annals of Mursili' - would survive for three thousand years, telling future generations of your struggles, your victories, and your devotion to the gods.\n\nYou had proven the doubters wrong. You had matched your father's legacy and forged your own. The empire stood strong, your succession was secure, and your name was remembered not just as 'son of Suppiluliuma' but as Mursili the Great in your own right.\n\nAs your body was prepared for the funeral pyre, the priests declared that the gods had shown their favor. Your detailed chronicles ensured your voice would echo through eternity."
            },
            tudhaliya: {
                name: "Tudhaliya IV",
                title: "The Embattled",
                startYear: 1237,
                victoryYear: 1197,
                targetYears: 40,
                difficultyMultiplier: 1.6,
                context: "The year is 1237 BCE, and the world is ending. You are Tudhaliya IV, and you inherit an empire under siege. The Sea Peoples raid your coasts. Trade routes collapse. Famine stalks the highlands. Assyria grows bold. The great kingdoms of the Bronze Age tremble as civilization itself seems to fray at the edges.\n\nYour treasury is nearly empty. Your army is stretched thin defending too many borders. The people whisper that the gods have abandoned Hatti. Your nobles plot in the shadows. Your advisors bring only bad news.\n\nYet you are not without hope. Hattusa's walls are strong. The Storm God still watches over his people. Your father taught you that kings are tested in crisis, not in comfort. You have 40 years - an entire generation - to hold back the darkness.\n\nThis will be the hardest reign of all. But if you can survive, if you can keep Hatti alive through the collapse, you will be remembered as the king who refused to let the empire die. Can you weather the storm and reach the shores of a peaceful death?",
                stats: {
                    treasury: 40,
                    military: 45,
                    popular: 45,
                    noble: 45,
                    religious: 50,
                    resources: 40,
                    egypt: 55,
                    assyria: 35,
                    kassite: 45
                },
                advisorLoyalty: {
                    hattusili: 55,
                    puduhepa: 60,
                    zida: 50,
                    kantuzzili: 55
                },
                escalations: {
                    assyrian: 2,
                    egyptian: 0,
                    kaska: 0,
                    noble: 0,
                    popular: 1,
                    religious: 0,
                    resources_crisis: 1,
                    financial: 0,
                    succession: 0,
                    rebellion: 0
                },
                victoryNarrative: "In the winter of 1197 BCE, Tudhaliya IV - called by later generations 'The Survivor' - died at the extraordinary age of one hundred years. Against all odds, you had lived to see the dawn of a new century, a new age.\n\nThe Bronze Age Collapse had come, as prophesied. Great kingdoms had fallen all around you - Mycenae, the Hittites' old rivals, were now nothing but burned ruins. The Sea Peoples had swept through like a plague. Trade had collapsed. Empires had turned to dust.\n\nBut Hatti survived. Not unchanged, not unscathed, but alive. Through four decades of crisis management, careful diplomacy, strategic retreats, and sheer stubborn endurance, you had kept the flame of Hittite civilization burning. Your people had food. Your capital stood. Your gods were still honored.\n\nAs you were laid to rest with all royal honors, the priests praised you not as a conqueror but as something rarer and more valuable - a king who had preserved his people through the end of the world. Future generations, living in the ashes of the Bronze Age, would speak your name with wonder: 'In the days when everything fell, Tudhaliya kept Hatti alive.'\n\nThat was legacy enough."
            }
        };

        // Event Data
        const events = {
            // Standard Events
            merchant_embassy: {
                title: "Assyrian Merchants Seek Trade Rights",
                description: "A delegation of Assyrian merchants arrives at your court, laden with exotic goods and honeyed words. They seek reduced tariffs and expanded trading privileges throughout your empire. Your treasurer eyes them suspiciously - Assyria is a rival, after all. But gold is gold, and your treasury could use the revenue.",
                category: "peaceful",
                icon: "üèõÔ∏è",
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "My lord, these Assyrians offer 45 talents of silver annually in increased trade revenue. That is worth three months of military wages!", mood: "worried" },
                    { advisor: "zida", text: "My agents report this 'trade delegation' includes two known spies. They will map our cities and count our granaries.", mood: "warning" },
                    { advisor: "hattusili", text: "Every Assyrian merchant is a potential spy, but we cannot fight them if we are bankrupting ourselves. Perhaps there is wisdom in this.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Grant generous trade concessions and welcome their merchants",
                        consequences: "The Assyrian merchants bow deeply, clearly pleased. Gold begins flowing into your treasury as new trade caravans arrive. Your own merchants grumble about foreign competition, but business is business. Zida's spies note increased Assyrian presence throughout your cities.",
                        effects: { treasury: 15, assyria: 10, popular: -5 },
                        escalationEffects: { assyrian: -1 },
                        advisorEffects: { kantuzzili: 15, zida: -10, hattusili: 5 }
                    },
                    {
                        text: "Accept limited trade but impose strict oversight and high tariffs",
                        consequences: "The Assyrians accept your terms with thin smiles. Trade increases modestly, and your inspectors keep close watch on their movements. It is a balanced arrangement that offends no one and enriches no one greatly.",
                        effects: { treasury: 8, assyria: 5 },
                        advisorEffects: { kantuzzili: 8, zida: 10, hattusili: 3 }
                    },
                    {
                        text: "Refuse their request and send them home empty-handed",
                        consequences: "The merchants depart with scarcely concealed anger. Word spreads that the King of Hatti is hostile to foreign trade. Your treasury remains unchanged, but you have made no new friends in Assur.",
                        effects: { assyria: -15, treasury: -5 },
                        escalationEffects: { assyrian: 1 },
                        advisorEffects: { zida: 15, hattusili: 10, kantuzzili: -15 }
                    }
                ]
            },

            spring_festival: {
                title: "The Spring Festival of the Storm God",
                description: "The annual spring festival approaches - the most sacred celebration in the Hittite calendar. The people expect their king to honor the Storm God with appropriate grandeur. The high priestess Puduhepa presents you with three options: a modest celebration, a traditional ceremony, or an unprecedented display of piety that would strain the treasury but awe the populace.",
                category: "religious",
                icon: "‚õ™",
                image: "religion.png",
                advisorCommentary: [
                    { advisor: "puduhepa", text: "The gods watch how their chosen king honors them. The Storm God grants us rain, victory, and life itself. How shall we show our gratitude?", mood: "thoughtful" },
                    { advisor: "kantuzzili", text: "A grand festival costs 30 talents of silver - that is two months worth of grain purchases. The traditional ceremony costs only 8 talents.", mood: "worried" },
                    { advisor: "hattusili", text: "The soldiers will expect good meat and strong beer at the festival. It is good for morale, regardless of religious considerations.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Fund an unprecedented grand festival with lavish sacrifices and public feasts",
                        consequences: "The festival is the most magnificent in living memory. One hundred bulls are sacrificed, wine flows like rivers, and the entire city feasts for three days. The priesthood proclaims the gods are well-pleased. The people sing your praises. Your treasury, however, groans under the expense.",
                        effects: { treasury: -25, religious: 20, popular: 15, noble: 5 },
                        advisorEffects: { puduhepa: 25, kantuzzili: -15, hattusili: 8 }
                    },
                    {
                        text: "Hold the traditional ceremony as your fathers did before you",
                        consequences: "The festival proceeds according to ancient custom. The proper sacrifices are made, the proper hymns sung, the proper rituals performed. The gods receive their due, the people are satisfied, and the treasury remains intact.",
                        effects: { treasury: -8, religious: 10, popular: 5 },
                        advisorEffects: { puduhepa: 10, kantuzzili: 5 }
                    },
                    {
                        text: "Conduct only a modest ceremony, citing the need to preserve resources",
                        consequences: "The festival is brief and austere. The required sacrifices are made but nothing more. The priesthood is visibly disappointed. Whispers spread through the city that the king is either miserly or impious - neither reputation is desirable.",
                        effects: { treasury: -3, religious: -10, popular: -8 },
                        advisorEffects: { puduhepa: -20, kantuzzili: 10, hattusili: -5 }
                    }
                ]
            },

            egyptian_princess: {
                title: "A Marriage Proposal from Egypt",
                description: "A royal embassy from Egypt arrives with a remarkable offer: Pharaoh proposes a marriage alliance between your son and an Egyptian princess. Such a union would formalize peace between your kingdoms and bring significant prestige. However, it would also entangle you in Egyptian politics and require substantial gifts to seal the agreement. The embassy awaits your answer in the throne room.",
                category: "peaceful",
                icon: "üëë",
                image: "egyptians.png",
                advisorCommentary: [
                    { advisor: "zida", text: "Egypt's internal politics are Byzantine, my lord. This princess is from a minor branch of the royal family. They are buying prestige with this match, not offering it.", mood: "warning" },
                    { advisor: "kantuzzili", text: "The customary bride-price for such an alliance is 50 talents of gold. That is an enormous sum, though peace with Egypt is worth far more.", mood: "worried" },
                    { advisor: "puduhepa", text: "A foreign princess may bring foreign gods to Hattusa. But an alliance sealed by marriage is stronger than treaties written on clay.", mood: "thoughtful" },
                    { advisor: "hattusili", text: "If we refuse, Egypt may seek alliance elsewhere. If we accept, we gain a powerful friend. The general's decision is clear.", mood: "aggressive" }
                ],
                choices: [
                    {
                        text: "Accept with generous gifts - seal the alliance properly",
                        consequences: "Pharaoh is delighted by your generosity. The princess arrives with great ceremony, and your son seems pleased with his exotic bride. Egypt considers you an honored ally and brother. The wedding costs a fortune, but you have bought peace with the greatest kingdom in the world.",
                        effects: { treasury: -40, egypt: 25, noble: 10, popular: 5 },
                        escalationEffects: { egyptian: -2 },
                        advisorEffects: { hattusili: 15, puduhepa: 10, kantuzzili: -20, zida: 5 }
                    },
                    {
                        text: "Accept but negotiate reduced bride-price",
                        consequences: "After lengthy negotiations, a reduced sum is agreed upon. The marriage proceeds, though the Egyptian ambassadors seem less enthusiastic than before. Still, an alliance is forged, and your treasury is less depleted.",
                        effects: { treasury: -20, egypt: 15, noble: 5 },
                        escalationEffects: { egyptian: -1 },
                        advisorEffects: { zida: 15, kantuzzili: 5, hattusili: 5, puduhepa: 5 }
                    },
                    {
                        text: "Politely decline - Hittite princes marry Hittite nobility",
                        consequences: "The Egyptian embassy departs with cold formality. Pharaoh is insulted by the rejection. Your nobles are pleased that foreign influence has been kept at bay, but you have missed an opportunity for a valuable alliance.",
                        effects: { egypt: -20, noble: 10, treasury: 5 },
                        escalationEffects: { egyptian: 1 },
                        advisorEffects: { puduhepa: -10, kantuzzili: 15, hattusili: -15, zida: 5 }
                    }
                ]
            },

            copper_shortage: {
                title: "Copper Supply Crisis",
                description: "Your smiths report a severe shortage of copper. The primary copper routes from Cyprus have been disrupted by pirates, and your bronze production has fallen dramatically. Without bronze, you cannot equip your army properly or fulfill trade obligations. Your advisors present several solutions, none of them simple.",
                category: "economic",
                icon: "üî®",
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "We can purchase emergency copper supplies from the Assyrians at three times the normal price - 35 talents of silver for a six-month supply.", mood: "worried" },
                    { advisor: "hattusili", text: "Send the fleet to Cyprus and clear out those pirates. It will cost us men, but it will solve the problem permanently.", mood: "aggressive" },
                    { advisor: "zida", text: "I have contacts with smugglers who can provide copper at only twice the normal price. It is technically illegal, but desperate times call for creative solutions.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Purchase emergency supplies from Assyria at premium prices",
                        consequences: "The Assyrian merchants are delighted to gouge you. Copper arrives quickly, and your smiths resume work. Your treasury is significantly lighter, but at least your bronze production continues. The Assyrians now know you are willing to overpay when desperate.",
                        effects: { treasury: -30, resources: 15, military: 10, assyria: 10 },
                        escalationEffects: { resources_crisis: -1 },
                        advisorEffects: { kantuzzili: -15, hattusili: 5, zida: -5 }
                    },
                    {
                        text: "Launch military expedition to clear Cyprus sea routes",
                        consequences: "Your fleet engages the pirates in a series of sharp actions. Victory is achieved, but at the cost of ships and men. The copper routes are reopened, and Cypriot merchants gratefully resume trade at normal prices. Your military reputation grows.",
                        effects: { military: -15, resources: 20, treasury: -10, noble: 10 },
                        escalationEffects: { resources_crisis: -2 },
                        advisorEffects: { hattusili: 20, kantuzzili: -10, puduhepa: -5 }
                    },
                    {
                        text: "Work with smugglers to acquire black market copper",
                        consequences: "The copper arrives discreetly through unofficial channels. Your smiths ask no questions. The supply problem is solved at reasonable cost, though you now owe favors to some rather unsavory characters. The priesthood frowns at these questionable business practices.",
                        effects: { treasury: -15, resources: 15, religious: -10 },
                        escalationEffects: { resources_crisis: -1 },
                        advisorEffects: { zida: 20, kantuzzili: 10, puduhepa: -15, hattusili: -5 }
                    },
                    {
                        text: "Ration copper and hope the crisis resolves itself",
                        consequences: "You implement strict rationing of existing copper supplies. Your smiths work with scrap and recycled bronze. Military equipment production slows to a trickle. The shortage continues to bite, and your army's readiness suffers. Sometimes hoping is not a strategy.",
                        effects: { military: -20, resources: -10, popular: -10 },
                        escalationEffects: { resources_crisis: 1 },
                        advisorEffects: { hattusili: -20, kantuzzili: 5, zida: -10 }
                    }
                ]
            },

            legal_dispute: {
                title: "The Merchant's Justice",
                description: "A wealthy Hittite merchant accuses a noble of seizing his goods without payment. The merchant has witnesses and documents. The noble claims his ancient family rights allow him to requisition supplies for royal service. Both parties demand your judgment. Whatever you decide will set precedent for future cases.",
                category: "justice",
                icon: "‚öñÔ∏è",
                image: "politics.png",
                advisorCommentary: [
                    { advisor: "zida", text: "Both are lying, my lord. The merchant under-reported the value by half to avoid taxes. The noble took three times what he claimed. But the law is the law.", mood: "warning" },
                    { advisor: "kantuzzili", text: "If nobles can seize merchant goods at will, trade will suffer. If merchants can sue nobles frivolously, the aristocracy will be outraged. Choose carefully.", mood: "worried" },
                    { advisor: "puduhepa", text: "The gods demand justice without regard to rank. A king who allows the strong to oppress the weak invites divine displeasure.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Rule in favor of the merchant - nobles must pay fair price",
                        consequences: "The merchant is vindicated. The noble is forced to pay compensation plus penalty. The aristocracy is furious at this blow to their privileges, but the merchant class celebrates. Trade becomes more secure, but you have made enemies among the nobles.",
                        effects: { noble: -15, popular: 15, treasury: 5 },
                        advisorEffects: { puduhepa: 15, kantuzzili: 10, hattusili: -10, zida: 5 }
                    },
                    {
                        text: "Rule in favor of the noble - ancient privileges must be respected",
                        consequences: "The noble departs satisfied. The merchant leaves your court bitter and defeated. The aristocracy approves of your respect for traditional rights, but merchants throughout the empire grow wary. Trade becomes more cautious.",
                        effects: { noble: 15, popular: -15, treasury: -5 },
                        advisorEffects: { hattusili: 10, puduhepa: -15, kantuzzili: -10 }
                    },
                    {
                        text: "Split the difference - both pay modest fines for dishonesty",
                        consequences: "Neither party is happy, but both accept your Solomon-like wisdom. You fine both for their deceptions and use the money for temple maintenance. The precedent is clear: the king sees through lies and punishes greed from any quarter.",
                        effects: { treasury: 5, religious: 10 },
                        advisorEffects: { zida: 15, puduhepa: 10, kantuzzili: 5 }
                    }
                ]
            },

            plague_caravan: {
                title: "Plague at the Gates",
                description: "A trade caravan from the south has reached your border gates, but your guards report that several merchants show signs of disease - fever, pustules, weakness. The caravan master pleads that they carry valuable goods and will pay handsomely for entry. Your physicians warn that letting them in could spread sickness throughout Hattusa. Time is of the essence.",
                category: "crisis",
                icon: "‚ò†Ô∏è",
                advisorCommentary: [
                    { advisor: "puduhepa", text: "Plague is the gods' punishment for sin. If we turn away the sick, we show mercy. If we let them enter, we may bring divine wrath upon Hattusa itself.", mood: "warning" },
                    { advisor: "kantuzzili", text: "They offer 20 talents of gold for entry. That is a fortune. But what price do we put on the health of our city?", mood: "worried" },
                    { advisor: "zida", text: "My agents report this plague has killed thousands in the southern kingdoms. We must not let it breach our walls.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Seal the borders completely - turn away the caravan",
                        consequences: "The caravan is turned away at spearpoint. The merchants curse your name, but your city remains healthy. Word spreads that Hatti values safety over profit. Trade decreases, but no plague enters your gates.",
                        effects: { popular: 10, treasury: -10, religious: 10 },
                        advisorEffects: { puduhepa: 15, zida: 15, kantuzzili: -15 }
                    },
                    {
                        text: "Quarantine the caravan for 30 days before allowing entry",
                        consequences: "The merchants are confined outside the city under guard. Most survive the quarantine period and are eventually admitted with their goods, though they are resentful of the delay. Three who were infected die in isolation. Your caution is vindicated - the plague does not spread.",
                        effects: { treasury: 5, popular: 5, resources: 5 },
                        advisorEffects: { puduhepa: 10, zida: 10, kantuzzili: 5 }
                    },
                    {
                        text: "Allow them entry - the risk is overstated",
                        consequences: "The caravan enters, and their goods are sold quickly. For a week, all seems well. Then the first cases appear among your people. The plague spreads through the lower city. Hundreds die. The temples overflow with desperate prayers. Your decision has brought suffering to your people.",
                        effects: { treasury: 15, popular: -30, religious: -15, resources: -10 },
                        advisorEffects: { kantuzzili: 10, puduhepa: -25, zida: -20, hattusili: -10 }
                    }
                ]
            },

            succession_question: {
                title: "Question of the Heir",
                description: "Your eldest son has proven himself a capable warrior and administrator. However, your younger son has won the hearts of the people with his charisma and generosity. The priesthood favors the elder for his piety, while the army admires the younger's battlefield courage. Some nobles suggest you should formally designate your heir now to prevent future disputes. Others warn this will create jealousy and intrigue.",
                category: "political",
                icon: "üëë",
                image: "politics.png",
                advisorCommentary: [
                    { advisor: "hattusili", text: "The younger son is a natural leader of men. I have seen him rally troops under fire. The army would follow him to the ends of the earth.", mood: "aggressive" },
                    { advisor: "puduhepa", text: "The gods favor order and tradition. The eldest son should inherit unless he is unworthy. Your younger son's virtues do not erase his brother's birthright.", mood: "thoughtful" },
                    { advisor: "zida", text: "My lord, designating an heir now will give one faction power and make the other desperate. Desperate men do desperate things. Perhaps maintain the ambiguity?", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Publicly designate your eldest son as heir",
                        consequences: "Your eldest son is overjoyed, and the priesthood approves of your respect for tradition. Your younger son hides his disappointment behind a smile, but you sense his hurt. The army grumbles. You have chosen stability over popularity.",
                        effects: { religious: 15, noble: 10, military: -10 },
                        escalationEffects: { succession: 1 },
                        advisorEffects: { puduhepa: 20, hattusili: -15, zida: -10 }
                    },
                    {
                        text: "Publicly designate your younger son as heir",
                        consequences: "The army erupts in cheers. The people celebrate in the streets. Your eldest son maintains his composure, but his eyes are cold. The priesthood is shocked by your breach of tradition. You have chosen the popular path, but at what cost to order?",
                        effects: { military: 15, popular: 15, religious: -15, noble: -10 },
                        escalationEffects: { succession: 1 },
                        advisorEffects: { hattusili: 20, puduhepa: -20, zida: -5 }
                    },
                    {
                        text: "Refuse to designate an heir - let them both prove themselves",
                        consequences: "You announce that the strongest son will inherit, judged by merit not birth. Both sons redouble their efforts to prove themselves. The competition is fierce but pushes both to excellence. However, the uncertainty creates anxiety and rival factions begin to form.",
                        effects: { military: 10, noble: -10 },
                        escalationEffects: { succession: 2 },
                        advisorEffects: { zida: 15, hattusili: 5, puduhepa: -15, kantuzzili: -5 }
                    }
                ]
            },

            golden_statue: {
                title: "The Vanity Project",
                description: "Your favorite sculptor proposes creating a massive golden statue of you enthroned beside the Storm God, to stand at the entrance to Hattusa. It would be a magnificent propaganda piece and a wonder that would awe visitors for generations. It would also cost an absolutely staggering amount of gold and take years to complete. The artist awaits your patronage.",
                category: "economic",
                icon: "üóø",
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "Seventy talents of gold, my lord. That is... that is nearly half our annual treasury income. I could feed the army for a year with that sum.", mood: "worried" },
                    { advisor: "puduhepa", text: "Such monuments can honor the gods or they can be monuments to royal pride. Be certain of your motives before you begin.", mood: "thoughtful" },
                    { advisor: "hattusili", text: "The Egyptians have their pyramids, the Babylonians their ziggurats. Should Hatti not have monuments to match? Let future generations know we were great.", mood: "aggressive" }
                ],
                choices: [
                    {
                        text: "Commission the golden statue - spare no expense",
                        consequences: "The project begins immediately. Gold is melted down, the finest artisans assembled. The statue will take years to complete, but when finished it will be breathtaking. Your name will be remembered. Your treasury will not soon recover.",
                        effects: { treasury: -60, noble: 15, popular: 10, religious: 10 },
                        advisorEffects: { hattusili: 20, puduhepa: 5, kantuzzili: -25 }
                    },
                    {
                        text: "Commission a smaller bronze statue instead",
                        consequences: "The sculptor is disappointed but accepts the reduced commission. The bronze statue will be impressive if not legendary. You spend prudently, and the project still brings glory to your reign without devastating the treasury.",
                        effects: { treasury: -20, noble: 5, popular: 5 },
                        advisorEffects: { kantuzzili: 10, puduhepa: 5, hattusili: -10 }
                    },
                    {
                        text: "Decline - the treasury cannot afford vanity projects",
                        consequences: "The sculptor leaves disappointed. Word spreads that you rejected a chance at immortal glory for mere gold. Some call it wisdom, others call it timidity. The treasury remains intact, but you have forgone a chance at legendary status.",
                        effects: { treasury: 5, noble: -10 },
                        advisorEffects: { kantuzzili: 20, hattusili: -15, puduhepa: 10 }
                    }
                ]
            },

            kaska_raiders: {
                title: "Kaska Raiders Strike the Northern Valleys",
                description: "The wild Kaska tribesmen have descended from their mountain strongholds and raided three villages in your northern territories. They have burned farms, stolen livestock, and killed a dozen of your subjects before vanishing back into the mountains. Your northern governors demand action. The Kaska have always been a thorn in Hatti's side, but they are difficult to punish in their mountain lairs.",
                category: "military",
                icon: "‚öîÔ∏è",
                image: "chariot.png",
                advisorCommentary: [
                    { advisor: "hattusili", text: "Send me with 500 men and I will bring you Kaska heads on spears. They only understand force. Every raid we ignore invites another.", mood: "aggressive" },
                    { advisor: "zida", text: "The Kaska mountains are a death trap for regular armies. We could spend months chasing shadows while real threats gather elsewhere.", mood: "warning" },
                    { advisor: "kantuzzili", text: "Rebuilding the destroyed villages will cost 12 talents. Mounting a military expedition costs 15 talents. Either way, we pay.", mood: "worried" }
                ],
                choices: [
                    {
                        text: "Launch a punitive expedition into Kaska territory",
                        consequences: "Your army marches north. After weeks of difficult mountain warfare, you inflict casualties on several Kaska settlements. Some tribute is extracted, prisoners taken. The expedition is expensive and exhausting, but the Kaska have been bloodied. They will think twice before raiding again... for a while.",
                        effects: { military: -10, treasury: -15, resources: -10, noble: 10 },
                        escalationEffects: { kaska: -1 },
                        advisorEffects: { hattusili: 20, kantuzzili: -15, zida: -10 }
                    },
                    {
                        text: "Strengthen border defenses and compensate victims",
                        consequences: "You choose defense over aggression. Watchtowers are built, garrison increased, the destroyed villages rebuilt and compensated. The Kaska are not punished, but your northern border becomes more secure. It is not a heroic solution, but it is a practical one.",
                        effects: { treasury: -10, popular: 10, military: 5 },
                        advisorEffects: { kantuzzili: 10, zida: 15, hattusili: -15 }
                    },
                    {
                        text: "Do nothing - the northern valleys are not worth the expense",
                        consequences: "You decline to act. The northern villages feel abandoned. The Kaska, emboldened by your inaction, begin planning larger raids. Your generals are disgusted by your passivity. Sometimes doing nothing is the most expensive option of all.",
                        effects: { military: -15, popular: -15, noble: -10 },
                        escalationEffects: { kaska: 2 },
                        advisorEffects: { hattusili: -25, puduhepa: -10, zida: -5 }
                    }
                ]
            },

            // Assyrian Escalation Chain
            assyrian_stage1: {
                title: "Assyrian Border Incident",
                description: "Reports arrive that Assyrian troops have crossed into your eastern territories and occupied a disputed border town. They claim the town was historically theirs and that your garrison provoked them. Your garrison captain insists the Assyrians attacked without warning. This could be a misunderstanding, or it could be the first move in a larger game.",
                category: "military",
                icon: "üèπ",
                escalationTrigger: { assyrian: 1 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "This is a test, my lord. If we accept this, they will take more. I have 800 troops ready to march east within two days.", mood: "aggressive" },
                    { advisor: "zida", text: "Assyria is testing your resolve. But they may also be genuinely confused about the border. We could resolve this diplomatically... or we could prepare for war.", mood: "warning" },
                    { advisor: "kantuzzili", text: "War with Assyria would cost us at minimum 50 talents for the first campaign. Can we afford this?", mood: "worried" }
                ],
                choices: [
                    {
                        text: "Send army to retake the town by force",
                        consequences: "Your army marches east and surrounds the town. After a brief but bloody fight, the Assyrian garrison surrenders. You have defended your territory, but Assyria will remember this humiliation. The drums of war beat louder.",
                        effects: { military: -15, assyria: -20, noble: 15, treasury: -15 },
                        escalationEffects: { assyrian: 1 },
                        advisorEffects: { hattusili: 25, zida: -10, kantuzzili: -15 }
                    },
                    {
                        text: "Demand Assyrian withdrawal through diplomatic channels",
                        consequences: "You send a stern message to Assur demanding withdrawal and compensation. After tense negotiations, the Assyrians agree to leave but pay no compensation. Both sides claim victory. The crisis is defused, for now.",
                        effects: { assyria: -5, noble: -5 },
                        advisorEffects: { zida: 15, kantuzzili: 10, hattusili: -15 }
                    },
                    {
                        text: "Concede the town to avoid conflict",
                        consequences: "You officially cede the disputed town to Assyria in exchange for promises of peace. The Assyrians are pleased by your reasonableness. Your own nobles are outraged by what they see as cowardice. Word spreads that the King of Hatti gives away territory without a fight.",
                        effects: { assyria: 15, noble: -20, military: -10, popular: -10 },
                        escalationEffects: { assyrian: -2 },
                        advisorEffects: { hattusili: -25, zida: 10, puduhepa: -10, kantuzzili: 5 }
                    }
                ]
            },

            assyrian_stage2: {
                title: "Assyrian Ultimatum",
                description: "An Assyrian embassy arrives with a formal ultimatum: cede three border provinces to Assyria or face war. They give you thirty days to decide. Your scouts report massive Assyrian troop movements on the border - this is not a bluff. The council chamber erupts in angry debates. Some advisors counsel submission, others demand resistance regardless of cost.",
                category: "military",
                icon: "üìú",
                escalationTrigger: { assyrian: 2 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "They demand surrender before the first arrow flies? This is intolerable! Give me command and I will show these desert dogs what Hittite iron tastes like!", mood: "aggressive" },
                    { advisor: "zida", text: "My agents estimate Assyria has assembled 12,000 troops on our border. We can match them, but it will be a near thing. This is their serious attempt at expansion.", mood: "warning" },
                    { advisor: "kantuzzili", text: "Those three provinces generate 40 talents of annual revenue. But a war will cost us at least 80 talents, probably more. Both options hurt.", mood: "worried" },
                    { advisor: "puduhepa", text: "The Storm God does not favor kings who surrender to threats. But he also does not favor those who lead their people to needless slaughter. Pray for wisdom.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Reject the ultimatum and prepare for war",
                        consequences: "You tear up the ultimatum in front of the Assyrian ambassadors. Your army mobilizes. The nobility rallies to your defiant stance. War is now inevitable. The Assyrian army will march soon. Prepare for blood and fire.",
                        effects: { noble: 20, military: 10, treasury: -30, popular: 10 },
                        escalationEffects: { assyrian: 1 },
                        queuedEvent: "assyrian_stage3",
                        advisorEffects: { hattusili: 30, puduhepa: 10, kantuzzili: -20, zida: -10 }
                    },
                    {
                        text: "Cede one province and negotiate for the other two",
                        consequences: "You offer a compromise: one province now, negotiations for the others. After tense bargaining, Assyria accepts. You have avoided war but shown some flexibility. Your nobles are unhappy but not mutinous. Assyria is moderately satisfied.",
                        effects: { assyria: 10, noble: -15, treasury: -20, popular: -10 },
                        escalationEffects: { assyrian: -1 },
                        advisorEffects: { zida: 20, kantuzzili: 10, hattusili: -20, puduhepa: -5 }
                    },
                    {
                        text: "Surrender all three provinces to preserve peace",
                        consequences: "You formally cede all three provinces. Assyria is delighted. Your own nobles are apoplectic with rage. The army feels betrayed. The common people wonder if their king has any spine. You have bought peace, but at an enormous cost to your authority and reputation.",
                        effects: { assyria: 25, noble: -30, military: -20, popular: -20, treasury: -15 },
                        escalationEffects: { assyrian: -3, noble: 2 },
                        advisorEffects: { hattusili: -35, puduhepa: -15, zida: 5, kantuzzili: 10 }
                    }
                ]
            },

            assyrian_stage3: {
                title: "The Assyrian War",
                description: "War has come. The Assyrian army crosses your border with banners flying and war horns blaring. Your own army marches to meet them. The two great hosts collide in the valley of the Tigris. Bronze crashes against bronze. Blood soaks the earth. For three days the battle rages. Your fate - and Hatti's - hangs in the balance.",
                category: "military",
                icon: "‚öîÔ∏è",
                image: "chariot.png",
                escalationTrigger: { assyrian: 3 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "This is the moment we train for, my lord. The Assyrians are fierce but our troops are veterans. Give the order and we will break them on our shields!", mood: "aggressive" },
                    { advisor: "zida", text: "Intelligence suggests their supply lines are overextended. If we can hold for a week, they may be forced to retreat. But that is a gamble.", mood: "warning" },
                    { advisor: "puduhepa", text: "I have prayed at the temple day and night. The omens... the omens are unclear. The gods will decide this battle.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Full aggressive assault - break them or be broken",
                        consequences: "You commit everything to a decisive assault. Your chariots smash into their lines. The battle is vicious and costly. When the dust settles, the Assyrian army is routed, fleeing back across the border. Victory is yours, but your army is bloodied and your treasury depleted by the campaign's costs. Assyria will not forget this defeat.",
                        effects: { military: -25, treasury: -40, noble: 25, popular: 20, assyria: -30 },
                        escalationEffects: { assyrian: -3 },
                        advisorEffects: { hattusili: 35, puduhepa: 10, kantuzzili: -20, zida: 5 }
                    },
                    {
                        text: "Defensive strategy - hold ground and outlast them",
                        consequences: "You order a defensive stance. Your troops dig in and hold their positions. The Assyrians attack repeatedly but cannot break through. After a week of fruitless assaults, they withdraw. It is not a glorious victory, but it is a victory nonetheless. Your casualties are moderate.",
                        effects: { military: -15, treasury: -20, assyria: -15, popular: 10 },
                        escalationEffects: { assyrian: -2 },
                        advisorEffects: { zida: 25, kantuzzili: 10, hattusili: 10, puduhepa: 15 }
                    },
                    {
                        text: "Seek last-minute negotiated settlement on battlefield",
                        consequences: "You send envoys during a lull in the fighting. After desperate negotiations under flag of truce, a settlement is reached. Both armies withdraw. Honor is barely satisfied on both sides. You have avoided catastrophic losses, but neither side really won. The war ends in exhaustion and mutual resentment.",
                        effects: { military: -10, treasury: -15, assyria: 5, noble: -15 },
                        escalationEffects: { assyrian: -2 },
                        advisorEffects: { zida: 15, kantuzzili: 15, hattusili: -25, puduhepa: 5 }
                    }
                ]
            },

            // Noble Conspiracy Escalation Chain
            noble_stage1: {
                title: "Whispers in the Court",
                description: "Your spymaster Zida reports concerning news: several prominent noble families have been meeting in secret. No overt treason has been detected, but these nobles have historically been ambitious. They may simply be discussing trade matters, or they may be plotting against you. The evidence is circumstantial but troubling.",
                category: "political",
                icon: "üïµÔ∏è",
                image: "politics.png",
                escalationTrigger: { noble: 1 },
                advisorCommentary: [
                    { advisor: "zida", text: "The Houses of Piyama-Radu and Alaksandu are meeting at night in sealed chambers. My agents cannot penetrate their inner circles. This is either mundane business or sophisticated treason.", mood: "warning" },
                    { advisor: "hattusili", text: "Arrest them now and question them harshly. A few days in the dungeons will reveal truth quickly enough. The army stands ready to enforce your will.", mood: "aggressive" },
                    { advisor: "kantuzzili", text: "These families control significant wealth and trade networks. Alienating them would be... economically painful. But ignoring treason would be fatal.", mood: "worried" }
                ],
                choices: [
                    {
                        text: "Have Zida intensify surveillance - gather more evidence first",
                        consequences: "You authorize increased surveillance. Zida's agents shadow the nobles day and night. More evidence trickles in - nothing conclusive yet, but the pattern of meetings continues. The nobles begin to suspect they are being watched. The game continues.",
                        effects: { noble: -10, treasury: -5 },
                        escalationEffects: { noble: 1 },
                        advisorEffects: { zida: 20, hattusili: -10, kantuzzili: 5 }
                    },
                    {
                        text: "Confront the noble leaders directly and demand explanations",
                        consequences: "You summon the noble leaders to court and demand an accounting of their meetings. They swear they were only discussing trade matters and seem genuinely surprised by your suspicion. They are either innocent or excellent liars. The confrontation diffuses some tension but may have revealed your concerns prematurely.",
                        effects: { noble: -5 },
                        escalationEffects: { noble: -1 },
                        advisorEffects: { zida: -15, kantuzzili: 10, puduhepa: 5 }
                    },
                    {
                        text: "Arrest the ringleaders on suspicion of conspiracy",
                        consequences: "You order the arrest of three noble family heads. They are imprisoned and questioned. No concrete evidence of treason is found. You are forced to release them after two weeks, now having made them into enemies without proving their guilt. Your preemptive strike may have stopped a conspiracy or created one.",
                        effects: { noble: -25, popular: -10 },
                        escalationEffects: { noble: 2 },
                        advisorEffects: { hattusili: 15, zida: -20, puduhepa: -15, kantuzzili: -10 }
                    }
                ]
            },

            noble_stage2: {
                title: "The Plot Thickens",
                description: "Zida bursts into your chambers with urgent news: his agents have intercepted coded messages between the noble families and a foreign power. The messages are partially decoded - they speak of 'changes coming soon' and 'support from our friends in Arzawa'. This is no longer mere suspicion. This is treason. But you need more evidence before you can act decisively.",
                category: "political",
                icon: "üìú",
                image: "politics.png",
                escalationTrigger: { noble: 2 },
                advisorCommentary: [
                    { advisor: "zida", text: "We have them, my lord. Give me two more weeks and I will have names, dates, and complete proof. Then we can strike with legal justification.", mood: "warning" },
                    { advisor: "hattusili", text: "Enough waiting! We know they conspire with Arzawa. That alone is treason. Round them up tonight before they can act. The army is ready.", mood: "aggressive" },
                    { advisor: "puduhepa", text: "Conspiracy with foreign powers is an offense against the gods themselves. But we must be just, even to the guilty. Ensure your evidence is complete before you act.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Wait for complete evidence before acting",
                        consequences: "You authorize Zida to continue his investigation. Two tense weeks pass. The evidence is gathered - names, meeting places, copies of the treasonous messages. When you finally strike, your case is ironclad. The conspirators are arrested, tried, and convicted based on overwhelming evidence. Justice is served.",
                        effects: { noble: -10, treasury: 5 },
                        escalationEffects: { noble: -2 },
                        queuedEvent: "noble_stage3",
                        advisorEffects: { zida: 25, puduhepa: 20, hattusili: -15, kantuzzili: 10 }
                    },
                    {
                        text: "Strike immediately with current evidence",
                        consequences: "You order immediate arrests based on the intercepted messages. The sweep is dramatic - twenty nobles arrested in one night. However, some of them may be innocent, caught up by association. The purge is effective but brutal. You have decapitated the conspiracy but at the cost of appearing tyrannical.",
                        effects: { noble: -20, popular: -15, military: 10 },
                        escalationEffects: { noble: -1 },
                        advisorEffects: { hattusili: 25, zida: -10, puduhepa: -15, kantuzzili: -10 }
                    },
                    {
                        text: "Leak information to the conspirators to make them act rashly",
                        consequences: "You have Zida deliberately leak false information suggesting you are vulnerable. The nobles take the bait and move their timeline up. They act prematurely, and their hastily planned coup attempt is easily crushed. However, the gambit was risky - it could have gone very wrong.",
                        effects: { noble: -15 },
                        escalationEffects: { noble: 1 },
                        queuedEvent: "noble_stage3",
                        advisorEffects: { zida: 20, hattusili: 15, puduhepa: -10, kantuzzili: -5 }
                    }
                ]
            },

            noble_stage3: {
                title: "The Conspiracy Unmasked",
                description: "The conspiracy has been exposed. The treasonous nobles stand before you in chains, surrounded by guards. The evidence of their plot to depose you with Arzawan support is undeniable. Your court watches in silence to see how you will dispense justice. Your decision here will echo through the remainder of your reign.",
                category: "political",
                icon: "‚öñÔ∏è",
                image: "chariot.png",
                escalationTrigger: { noble: 3 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "Execute them all. Publicly. Let every noble in the empire see what happens to traitors. Mercy to traitors is cruelty to the loyal.", mood: "aggressive" },
                    { advisor: "puduhepa", text: "Justice must be done, but let it be justice, not vengeance. Execute the ringleaders, show mercy to those who were coerced or misled.", mood: "thoughtful" },
                    { advisor: "zida", text: "Some of these nobles have valuable information about foreign plots. Spare them in exchange for complete cooperation. Dead men tell no tales.", mood: "warning" },
                    { advisor: "kantuzzili", text: "These families control vast estates and wealth. Confiscation of their assets would replenish the treasury significantly - 60 talents at minimum.", mood: "worried" }
                ],
                choices: [
                    {
                        text: "Execute all conspirators and confiscate their estates",
                        consequences: "Justice is swift and merciless. Twenty noble heads roll. Their estates are seized and distributed to loyal families. The message is clear: treason means death. No noble will dare plot against you again. But fear is a brittle foundation for loyalty.",
                        effects: { noble: -20, military: 20, treasury: 50, popular: 10 },
                        escalationEffects: { noble: -3 },
                        advisorEffects: { hattusili: 35, puduhepa: -10, zida: -5, kantuzzili: 20 }
                    },
                    {
                        text: "Execute ringleaders, exile the rest with property confiscation",
                        consequences: "The three chief conspirators are executed. The others are exiled with their families, their estates confiscated. It is harsh but not bloodthirsty. The nobility sees that you can distinguish between leaders and followers. Justice is tempered with pragmatism.",
                        effects: { noble: -10, treasury: 40, popular: 5 },
                        escalationEffects: { noble: -3 },
                        advisorEffects: { puduhepa: 25, zida: 15, hattusili: 10, kantuzzili: 15 }
                    },
                    {
                        text: "Spare most in exchange for intelligence and future loyalty oaths",
                        consequences: "You execute only the two chief conspirators. The rest are spared in exchange for detailed confessions and solemn loyalty oaths. You gain valuable intelligence about foreign interference. The mercy is noted but also seen as possible weakness. Some nobles are relieved, others wonder if treason has become cheap.",
                        effects: { noble: 10, treasury: 15, military: -10 },
                        escalationEffects: { noble: -2 },
                        advisorEffects: { zida: 25, puduhepa: 15, hattusili: -25, kantuzzili: 5 }
                    }
                ]
            },

            // Popular Unrest Escalation Chain
            popular_stage1: {
                title: "Bread and Discontent",
                description: "The price of bread has risen sharply in Hattusa. Grain merchants are accused of hoarding supplies to drive up prices. Angry crowds gather in the lower city markets. No violence yet, but your city watch reports growing unrest. The people are angry, and they are looking to you for relief.",
                category: "economic",
                icon: "üåæ",
                escalationTrigger: { popular: 1 },
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "The merchants are profiteering, but if we impose price controls, they will simply stop selling. The market must be allowed to function, even if prices are high.", mood: "worried" },
                    { advisor: "puduhepa", text: "The people hunger while merchants grow fat. This is an offense against the gods who command us to care for the weak. Feed your people, my lord.", mood: "thoughtful" },
                    { advisor: "zida", text: "Bread riots have toppled kings before. This must be dealt with before anger turns to violence.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Open royal granaries and distribute free bread to the people",
                        consequences: "You order the royal granaries opened. Free bread is distributed to the hungry. The crowds cheer your generosity. The crisis is defused, though your grain reserves are significantly depleted. The merchants grumble but dare not complain too loudly.",
                        effects: { popular: 20, treasury: -15, resources: -20 },
                        escalationEffects: { popular: -2 },
                        advisorEffects: { puduhepa: 25, kantuzzili: -15, zida: 10 }
                    },
                    {
                        text: "Impose price controls and punish profiteering merchants",
                        consequences: "You decree maximum bread prices and fine merchants caught hoarding. The policy is popular with the masses but hated by the merchant class. Some merchants begin selling less or smuggling grain out of the city. The unrest is calmed but the economic problems continue.",
                        effects: { popular: 15, treasury: 5, noble: -15 },
                        escalationEffects: { popular: -1 },
                        advisorEffects: { puduhepa: 15, kantuzzili: -10, zida: 5 }
                    },
                    {
                        text: "Do nothing - let the market resolve itself",
                        consequences: "You refuse to interfere in the market. Prices remain high. The unrest grows. The people feel abandoned by their king. Within days, the first riots break out in the lower city. What began as grumbling has become violent anger.",
                        effects: { popular: -25, treasury: 5 },
                        escalationEffects: { popular: 2 },
                        advisorEffects: { kantuzzili: 10, puduhepa: -25, zida: -15, hattusili: -10 }
                    }
                ]
            },

            popular_stage2: {
                title: "The Mob Gathers",
                description: "The unrest has grown into open protest. Thousands gather in the great square before your palace, demanding relief from high prices, lower taxes, and justice for the common people. They are not yet violent, but the crowd's mood is ugly. Some carry improvised weapons. Your palace guard eyes them nervously.",
                category: "political",
                icon: "üë•",
                escalationTrigger: { popular: 2 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "Clear the square with troops. Now, before this becomes a full rebellion. A show of force will disperse them. Mobs respect only strength.", mood: "aggressive" },
                    { advisor: "puduhepa", text: "Go to them yourself. Speak to your people. They are angry but not beyond reason. A king who hides in his palace while his people cry out is no king at all.", mood: "thoughtful" },
                    { advisor: "zida", text: "There are agitators in that crowd - professional troublemakers stirring the pot. If we can identify and arrest the leaders, the rest may disperse peacefully.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Address the crowd personally and promise reforms",
                        consequences: "You emerge from the palace and address the crowd directly. You promise tax relief, action against profiteering, and that you hear their grievances. The crowd is shocked by your personal appearance. Some are won over immediately. The mood shifts from anger to cautious hope. You have bought time with promises - now you must deliver.",
                        effects: { popular: 20, noble: -10, treasury: -10 },
                        escalationEffects: { popular: -2 },
                        advisorEffects: { puduhepa: 30, hattusili: -10, zida: 10, kantuzzili: -10 }
                    },
                    {
                        text: "Have Zida arrest the ringleaders quietly",
                        consequences: "Zida's agents move through the crowd and quietly seize the obvious troublemakers. The arrests are swift and efficient. Without their leaders, the crowd loses focus and gradually disperses. Order is restored, but the underlying grievances remain unaddressed.",
                        effects: { popular: -5 },
                        escalationEffects: { popular: -1 },
                        advisorEffects: { zida: 25, hattusili: 10, puduhepa: -15, kantuzzili: 5 }
                    },
                    {
                        text: "Disperse the crowd with military force",
                        consequences: "You order troops to clear the square. The soldiers advance with spears and shields. The crowd resists. Violence erupts. When it is over, the square is empty but dozens lie wounded or dead. You have imposed order through blood. The people will not forgive this easily.",
                        effects: { popular: -30, military: -10, noble: 10 },
                        escalationEffects: { popular: 1 },
                        advisorEffects: { hattusili: 15, puduhepa: -30, zida: -15, kantuzzili: -10 }
                    }
                ]
            },

            popular_stage3: {
                title: "Rebellion in the Streets",
                description: "The protests have turned into open revolt. Barricades have been erected in the lower city. Your tax collectors have been driven out. A self-proclaimed 'people's council' is issuing demands. This is no longer unrest - this is rebellion. Your authority hangs in the balance.",
                category: "political",
                icon: "‚öîÔ∏è",
                escalationTrigger: { popular: 3 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "This is war, my lord. Treat it as such. I will take the lower city street by street if I must. Rebellion cannot be tolerated.", mood: "aggressive" },
                    { advisor: "puduhepa", text: "These are your people, not your enemies. Meet with their council. Hear their demands. Some may be just. A king who makes war on his own people has already lost.", mood: "thoughtful" },
                    { advisor: "zida", text: "The 'people's council' includes known criminals and foreign agitators. This is not pure popular uprising - someone is backing them. Find the puppet masters.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Negotiate with the rebel council and grant major concessions",
                        consequences: "You meet with the rebel council under flag of truce. After tense negotiations, you grant tax reductions, grain distributions, and other reforms. The rebellion ends peacefully. Your treasury is strained and your authority is somewhat diminished, but bloodshed is avoided and the people are satisfied.",
                        effects: { popular: 30, treasury: -30, noble: -20, military: -10 },
                        escalationEffects: { popular: -3 },
                        advisorEffects: { puduhepa: 35, hattusili: -25, zida: -10, kantuzzili: -20 }
                    },
                    {
                        text: "Military assault to retake the lower city",
                        consequences: "Your army storms the barricades. The fighting is fierce and bitter. House to house, street to street, the lower city is retaken. Hundreds die on both sides. Order is restored through violence. The rebellion is crushed, but the cost in blood and popular support is staggering.",
                        effects: { popular: -35, military: -25, noble: 15, treasury: -20 },
                        escalationEffects: { popular: -2 },
                        advisorEffects: { hattusili: 25, puduhepa: -35, zida: -15, kantuzzili: -15 }
                    },
                    {
                        text: "Isolate the lower city and starve out the rebellion",
                        consequences: "You order the lower city sealed off and blockaded. No food goes in. No one comes out. After two weeks of hardship, the rebellion collapses as hunger breaks their will. It is a cruel victory. The people submit, but they hate you for it. Sometimes winning means losing.",
                        effects: { popular: -40, military: -10, resources: -15 },
                        escalationEffects: { popular: -2 },
                        advisorEffects: { zida: 15, hattusili: 10, puduhepa: -35, kantuzzili: -10 }
                    }
                ]
            },

            // Resource Crisis Escalation Chain
            resources_stage1: {
                title: "Grain Shortage Warning",
                description: "Your granary administrators report concerning news: this year's harvest was below expectations, and current grain reserves are lower than normal for this time of year. It is not yet a crisis, but if next harvest is also poor, you could face serious shortages. Your advisors debate whether to take preventive action now or wait.",
                category: "economic",
                icon: "üåæ",
                escalationTrigger: { resources_crisis: 1 },
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "We should purchase emergency grain from Egypt now while prices are reasonable. It will cost 25 talents but will ensure we have adequate reserves.", mood: "worried" },
                    { advisor: "zida", text: "Bad weather happens. The next harvest may be fine. Spending treasury gold on grain that may not be needed is premature.", mood: "warning" },
                    { advisor: "puduhepa", text: "I will order prayers and sacrifices for a good harvest. But the gods also expect us to be prudent. Prepare for the worst while hoping for the best.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Purchase emergency grain reserves from abroad now",
                        consequences: "You authorize the purchase of large grain shipments from Egypt and Babylon. The treasury takes a hit, but your granaries are filled to capacity. When next harvest season arrives, your prudence is vindicated - the harvest is indeed poor, but your people are fed thanks to your foresight.",
                        effects: { treasury: -25, resources: 25 },
                        escalationEffects: { resources_crisis: -2 },
                        advisorEffects: { kantuzzili: 20, puduhepa: 15, zida: -10 }
                    },
                    {
                        text: "Implement grain rationing and conservation measures",
                        consequences: "You decree grain rationing and launch a conservation campaign. The measures are unpopular but effective. Reserves stabilize. You navigate the shortage through careful management without spending precious treasury gold.",
                        effects: { popular: -10, resources: 10 },
                        escalationEffects: { resources_crisis: -1 },
                        advisorEffects: { kantuzzili: 10, zida: 15, puduhepa: 10 }
                    },
                    {
                        text: "Do nothing - next harvest will probably be better",
                        consequences: "You decide to wait. Unfortunately, next harvest is also poor. The grain shortage becomes serious. Prices spike. The people begin to go hungry. Your failure to act when warned now comes back to haunt you.",
                        effects: { resources: -20, popular: -15 },
                        escalationEffects: { resources_crisis: 2 },
                        advisorEffects: { kantuzzili: -20, puduhepa: -15, zida: -10 }
                    }
                ]
            },

            resources_stage2: {
                title: "Famine Approaches",
                description: "The grain situation has become critical. Reserves are dangerously low. Bread prices have tripled. The poor are going hungry. Your advisors warn that if something is not done immediately, famine will sweep through your cities. Desperate times call for desperate measures.",
                category: "economic",
                icon: "‚ò†Ô∏è",
                escalationTrigger: { resources_crisis: 2 },
                advisorCommentary: [
                    { advisor: "kantuzzili", text: "Emergency grain purchases now will cost 50 talents - prices have skyrocketed. But what is gold compared to starvation? We must pay whatever it takes.", mood: "worried" },
                    { advisor: "puduhepa", text: "Open the temple granaries. The gods' grain can feed the people in this time of need. Preserving life is the highest religious duty.", mood: "thoughtful" },
                    { advisor: "hattusili", text: "Send armed expeditions to seize grain from neighboring regions. We can apologize later. Right now, our people are starving.", mood: "aggressive" }
                ],
                choices: [
                    {
                        text: "Pay exorbitant prices for emergency grain imports",
                        consequences: "You empty a large portion of the royal treasury to purchase grain at crisis prices. Foreign merchants know you are desperate and charge accordingly. The grain arrives and immediate starvation is prevented, but your finances are devastated. At least your people live.",
                        effects: { treasury: -50, resources: 30, popular: 15 },
                        escalationEffects: { resources_crisis: -2 },
                        advisorEffects: { puduhepa: 20, kantuzzili: -15, hattusili: -5 }
                    },
                    {
                        text: "Open temple granaries and distribute sacred grain reserves",
                        consequences: "You order the temples to open their grain reserves to the people. The priesthood reluctantly complies. The sacred grain feeds the hungry. Immediate crisis is averted, though some religious conservatives grumble about sacrilege. Puduhepa defends the decision firmly.",
                        effects: { resources: 25, religious: -10, popular: 20 },
                        escalationEffects: { resources_crisis: -2 },
                        advisorEffects: { puduhepa: 25, hattusili: 5, zida: 5, kantuzzili: 10 }
                    },
                    {
                        text: "Launch raids to seize grain from weaker neighbors",
                        consequences: "You send armed expeditions to 'requisition' grain from smaller vassal states and neighboring regions. The operation is successful - grain flows back to Hattusa. Your people are fed, but you have essentially committed robbery. Your diplomatic reputation suffers, and the victims will remember.",
                        effects: { resources: 25, military: -10, egypt: -15, assyria: -10, kassite: -10, popular: 15 },
                        escalationEffects: { resources_crisis: -2 },
                        advisorEffects: { hattusili: 25, puduhepa: -20, zida: 5, kantuzzili: 5 }
                    },
                    {
                        text: "Strict rationing and hope we can endure until next harvest",
                        consequences: "You implement draconian rationing. The bare minimum to survive is distributed. People suffer. Some die. Riots break out. But you conserve treasury gold and gamble that you can endure until next harvest. It is a brutal choice that may haunt you.",
                        effects: { popular: -30, resources: -15, treasury: 5 },
                        escalationEffects: { resources_crisis: 1 },
                        advisorEffects: { kantuzzili: -15, puduhepa: -30, zida: -15, hattusili: -20 }
                    }
                ]
            },

            resources_stage3: {
                title: "Famine Crisis",
                description: "Famine has arrived. People are dying in the streets. Desperate families abandon their children at temple gates. Bread riots are daily occurrences. Disease follows hunger. The situation is catastrophic. Your kingdom teeters on the brink of collapse. This is your final chance to save your people - or watch them die.",
                category: "crisis",
                icon: "üíÄ",
                escalationTrigger: { resources_crisis: 3 },
                advisorCommentary: [
                    { advisor: "puduhepa", text: "This is divine punishment for our sins. We must show the gods we are worthy of their mercy through extreme measures. Whatever it takes to save lives.", mood: "thoughtful" },
                    { advisor: "kantuzzili", text: "We can mortgage future revenues, empty the royal jewelry, sell the palace horses - anything that converts to grain-buying power. The treasury means nothing if the kingdom starves.", mood: "worried" },
                    { advisor: "hattusili", text: "Send the army to take grain by force from ANYONE who has it - nobles, temples, foreign caravans. The crisis demands it. Apologize to the gods later.", mood: "aggressive" }
                ],
                choices: [
                    {
                        text: "Spend everything - empty the entire treasury to buy food",
                        consequences: "You liquidate everything. Royal treasures are sold. Every talent of silver is spent. Massive grain shipments are purchased at any price. The famine is broken through sheer financial desperation. Your people live. Your treasury is destroyed. You have bought survival at the cost of your kingdom's wealth.",
                        effects: { treasury: -70, resources: 40, popular: 30, noble: -15 },
                        escalationEffects: { resources_crisis: -3 },
                        advisorEffects: { puduhepa: 35, kantuzzili: -25, hattusili: -10, zida: 5 }
                    },
                    {
                        text: "Seize all private grain stocks by royal decree",
                        consequences: "You declare royal emergency powers and seize all grain from nobles, merchants, and temples. The grain is redistributed to the starving masses. The famine is broken, but you have made enemies of every wealthy person in the kingdom. Your authority is secure, but your popularity with the elite is shattered.",
                        effects: { resources: 40, noble: -35, popular: 30, religious: -20, military: 10 },
                        escalationEffects: { resources_crisis: -3, noble: 2 },
                        advisorEffects: { hattusili: 25, puduhepa: -15, zida: 5, kantuzzili: -20 }
                    },
                    {
                        text: "Massive emergency loans from foreign powers",
                        consequences: "You go hat-in-hand to Egypt, Assyria, and Babylon, begging for loans. They agree, but the terms are harsh - you are essentially mortgaging your kingdom's future. The grain arrives and saves your people. But you are now deeply in debt to foreign powers who will expect repayment with interest.",
                        effects: { resources: 35, treasury: -30, egypt: 15, assyria: 10, kassite: 10, noble: -10 },
                        escalationEffects: { resources_crisis: -3, financial: 2 },
                        advisorEffects: { kantuzzili: -20, puduhepa: 15, zida: -10, hattusili: -15 }
                    }
                ]
            },

            // High Loyalty Advisor Events
            hattusili_loyal: {
                title: "Hattusili's Triumph",
                description: "Your general Hattusili returns from a campaign with a string of impressive victories. He has defeated a coalition of raiders, recovered stolen livestock, and even captured a small fortress. The army adores him. He presents the spoils of victory to you with genuine pride and loyalty. His devotion to your reign is absolute.",
                category: "military",
                icon: "‚öîÔ∏è",
                loyaltyTrigger: { hattusili: 85 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "My lord, these victories belong to you. The army fights in your name. I am merely your instrument. As long as I draw breath, no enemy will threaten Hatti while I have strength to stand.", mood: "aggressive" }
                ],
                choices: [
                    {
                        text: "Reward him lavishly with gold and new titles",
                        consequences: "You honor Hattusili with new titles, gold, and lands. He accepts with visible emotion. The army celebrates their beloved general's recognition. His loyalty to you deepens even further. A king who rewards faithful service inspires more faithful service.",
                        effects: { military: 15, noble: 5, treasury: -10 },
                        advisorEffects: { hattusili: 15 }
                    },
                    {
                        text: "Thank him personally and share the glory with the troops",
                        consequences: "You praise Hattusili publicly but spread the rewards among all his soldiers. The general appreciates your wisdom in maintaining army morale. The troops are overjoyed. Hattusili's loyalty remains rock-solid while the entire army's morale improves.",
                        effects: { military: 20, popular: 10, treasury: -15 },
                        advisorEffects: { hattusili: 10 }
                    }
                ]
            },

            puduhepa_loyal: {
                title: "Divine Favor Confirmed",
                description: "High Priestess Puduhepa emerges from the temple after a week of prayers and rituals. She announces that the omens are extraordinarily favorable - the Storm God has shown his approval of your reign in unmistakable signs. Her announcement carries great weight with the religious population. Her faith in your kingship is absolute.",
                category: "religious",
                icon: "‚õ™",
                loyaltyTrigger: { puduhepa: 85 },
                advisorCommentary: [
                    { advisor: "puduhepa", text: "The gods speak clearly, my lord. Your reign is blessed. I have served many kings, but never have I seen such clear divine favor. The Storm God protects you.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Fund a major temple expansion in gratitude",
                        consequences: "You order a magnificent expansion of the Storm God's temple. Puduhepa is overjoyed. The priesthood proclaims your piety. The people see their king honoring the gods. Your religious authority reaches new heights.",
                        effects: { religious: 20, treasury: -20, popular: 10 },
                        advisorEffects: { puduhepa: 15 }
                    },
                    {
                        text: "Accept humbly and dedicate yourself to righteous rule",
                        consequences: "You accept the divine favor with humility and publicly dedicate yourself to ruling justly in the gods' name. Puduhepa approves of your lack of arrogance. The people appreciate your piety. Your moral authority grows.",
                        effects: { religious: 15, popular: 10 },
                        advisorEffects: { puduhepa: 10 }
                    }
                ]
            },

            // Betrayal Warning Events
            hattusili_betrayal_warning: {
                title: "The General's Discontent",
                description: "Hattusili has become increasingly critical of your military decisions. He speaks openly of his frustration with your leadership. His officers listen to him more than to you. The army's loyalty is shifting from king to general. Zida warns this is how military coups begin. You must address this before it is too late.",
                category: "political",
                icon: "‚ö†Ô∏è",
                loyaltyTrigger: { hattusili: 10 },
                advisorCommentary: [
                    { advisor: "zida", text: "The general meets nightly with his officers. They discuss 'what Hatti needs'. This is extremely dangerous, my lord. He has the army's loyalty, and he knows it.", mood: "warning" },
                    { advisor: "puduhepa", text: "Hattusili is an honorable man, but even honor has limits. If he believes you are destroying the kingdom through incompetence, he may feel duty-bound to act.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Give him supreme military command to restore his confidence in you",
                        consequences: "You grant Hattusili extraordinary military powers and authority. He is mollified by this show of trust. His criticism softens. However, you have just made your most discontented advisor the most powerful man in your military.",
                        effects: { military: 15, noble: -10 },
                        advisorEffects: { hattusili: 20, zida: -15 }
                    },
                    {
                        text: "Confront him directly about his disloyalty",
                        consequences: "You summon Hattusili and demand to know if he intends to remain loyal. He is shocked by your directness. He swears renewed loyalty, seeming genuinely chastened. The confrontation clears the air, for now.",
                        effects: { military: 5 },
                        advisorEffects: { hattusili: 10, zida: 5 }
                    },
                    {
                        text: "Have Zida monitor him closely and prepare for the worst",
                        consequences: "You order Hattusili placed under surveillance. Zida's agents shadow him constantly. The general becomes aware he is being watched. His resentment deepens. You have bought time but not solved the problem.",
                        effects: { military: -10 },
                        advisorEffects: { hattusili: -5, zida: 15 }
                    }
                ]
            },

            // Betrayal Events
            hattusili_betrayal: {
                title: "The General's Coup",
                description: "It has happened. Hattusili has turned against you. In the pre-dawn darkness, his troops surrounded the palace. He stands at the gate with drawn sword, flanked by the army's best soldiers. He declares you unfit to rule and calls for your abdication. Your loyal guards are outnumbered. This is the moment of ultimate crisis.",
                category: "crisis",
                icon: "‚öîÔ∏è",
                image: "chariot.png",
                loyaltyTrigger: { hattusili: 0 },
                advisorCommentary: [
                    { advisor: "zida", text: "I have a secret passage out of the palace. We can escape, regroup, and counterattack from a loyalist province. All is not lost.", mood: "warning" },
                    { advisor: "puduhepa", text: "The Storm God will judge Hattusili for this treason. But right now, the treason is succeeding. You must decide: fight or flee.", mood: "thoughtful" }
                ],
                choices: [
                    {
                        text: "Abdicate peacefully to avoid bloodshed",
                        consequences: "You step onto the palace balcony and announce your abdication. Hattusili accepts your surrender. You are allowed to leave the city with your family. Your reign ends not in violence but in humiliation. The chronicles will record that you yielded your throne without a fight.",
                        effects: {},
                        gameOver: "abdication"
                    },
                    {
                        text: "Rally the palace guard and fight",
                        consequences: "You order the palace guard to defend the throne. A fierce battle erupts. You fight bravely but you are outnumbered ten to one. The palace falls. You die sword in hand, refusing to surrender. It is a courageous end, but it is still an end.",
                        effects: {},
                        gameOver: "military_defeat"
                    },
                    {
                        text: "Escape through secret passages and mount resistance",
                        consequences: "You flee through Zida's secret tunnels. But Hattusili's forces are everywhere. You are captured while trying to reach loyalist territories. The general shows no mercy to a fugitive king. Your reign ends in capture and imprisonment.",
                        effects: {},
                        gameOver: "captured"
                    }
                ]
            },

            puduhepa_betrayal: {
                title: "Religious Condemnation",
                description: "High Priestess Puduhepa stands before a massive assembly in the Storm God's temple. With the authority of the priesthood behind her, she declares that the gods have withdrawn their favor from you. She proclaims you unfit to rule, cursed by the divine powers. The religious condemnation threatens to destroy your legitimacy completely.",
                category: "crisis",
                icon: "‚õ™",
                image: "religion.png",
                loyaltyTrigger: { puduhepa: 0 },
                advisorCommentary: [
                    { advisor: "hattusili", text: "Arrest her for sedition! She uses religion as a weapon against the throne. The army will back you against the priesthood.", mood: "aggressive" },
                    { advisor: "zida", text: "Religious condemnation is extremely dangerous, my lord. The common people believe the priesthood speaks for the gods. This could topple your reign.", mood: "warning" }
                ],
                choices: [
                    {
                        text: "Submit to religious judgment and perform public penance",
                        consequences: "You humble yourself before the priesthood. You perform elaborate public penance rituals. The humiliation is complete. Your authority is destroyed. Within months, you are forced to abdicate in favor of a more 'godly' successor.",
                        effects: {},
                        gameOver: "religious_condemnation"
                    },
                    {
                        text: "Arrest Puduhepa and suppress the priesthood",
                        consequences: "You order Puduhepa arrested for treason. The priests resist. Violence erupts in the temple. The religious authorities are brutally suppressed, but popular outrage is immense. Riots sweep the city. Your reign collapses in chaos.",
                        effects: {},
                        gameOver: "popular_revolt"
                    }
                ]
            }
        };

        // Screen Management
        function showScreen(screenId) {
            playSound('whoosh');
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'gameScreen') {
                startBackgroundMusic();
            }
        }

        // Character Selection
        function selectKing(kingId) {
            playSound('click');
            gameState.selectedKing = kingId;
            const king = kingData[kingId];
            
            document.getElementById('contextTitle').textContent = `${king.name} - ${king.title}`;
            document.getElementById('contextContent').textContent = king.context;
            
            showScreen('historicalContext');
        }

        function actuallyStartGame() {
            playSound('click');
            const king = kingData[gameState.selectedKing];
            
            // Initialize game state from king data
            gameState.kingName = king.name;
            gameState.startYear = king.startYear;
            gameState.currentYear = king.startYear;
            gameState.victoryYear = king.victoryYear;
            gameState.targetYears = king.targetYears;
            gameState.difficultyMultiplier = king.difficultyMultiplier;
            gameState.stats = { ...king.stats };
            gameState.advisorLoyalty = { ...king.advisorLoyalty };
            gameState.escalations = { ...king.escalations };
            gameState.firstEvent = true;
            gameState.eventCount = 0;
            gameState.recentEvents = [];
            gameState.queuedEvent = null;
            gameState.advisorBetrayalWarned = {
                hattusili: false,
                puduhepa: false,
                zida: false,
                kantuzzili: false
            };
            gameState.lastMilestones = {};
            
            showScreen('gameScreen');
            updateStats();
            nextEvent();
        }

        // Time System
        function advanceTime() {
            // Only advance time after first event
            if (gameState.eventCount > 0) {
                const increment = 0.4 + Math.random() * 0.1; // 0.4-0.5 years
                gameState.currentYear += increment;
            }
            updateTimeDisplay();
        }

        function getSeason() {
            const yearFraction = gameState.currentYear - Math.floor(gameState.currentYear);
            if (yearFraction < 0.25) return "Spring";
            if (yearFraction < 0.5) return "Summer";
            if (yearFraction < 0.75) return "Autumn";
            return "Winter";
        }

        function updateTimeDisplay() {
            const year = Math.floor(gameState.currentYear);
            const season = getSeason();
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            const yearsToVictory = gameState.targetYears - yearsRuled;
            
            document.getElementById('timeDisplay').innerHTML = `
                <div class="year">${year} BCE</div>
                <div class="season">${season}</div>
                <div class="progress">Ruled ${yearsRuled} years | ${yearsToVictory} years until succession</div>
            `;
        }

        // Stats Management
        function updateStats() {
            // Update stat bars
            const statLabels = {
                treasury: "üí∞ Treasury",
                military: "‚öîÔ∏è Military",
                popular: "üë• Popular Support",
                noble: "üëë Noble Loyalty",
                religious: "‚õ™ Religious Authority",
                resources: "üåæ Resources",
                egypt: "üê™ Egypt Relations",
                assyria: "üèπ Assyria Relations",
                kassite: "üèõÔ∏è Kassite Relations"
            };
            
            let statsHTML = '';
            for (let [stat, label] of Object.entries(statLabels)) {
                const value = Math.max(0, Math.min(100, gameState.stats[stat]));
                let colorClass = 'high';
                if (value < 50) colorClass = 'medium';
                if (value < 25) colorClass = 'low';
                
                statsHTML += `
                    <div class="stat-bar">
                        <div class="stat-label">
                            <span>${label}</span>
                            <span class="stat-value">${Math.round(value)}/100</span>
                        </div>
                        <div class="stat-progress">
                            <div class="stat-fill ${colorClass}" style="width: ${value}%"></div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('statsContainer').innerHTML = statsHTML;
            
            // Update advisor portraits
            updateAdvisorPortraits();
            
            // Update time display
            updateTimeDisplay();
            
            // Check for game over
            for (let [stat, value] of Object.entries(gameState.stats)) {
                if (value <= 0) {
                    gameOver(stat);
                    return;
                }
                // Critical warning at 15 or below
                if (value <= 15) {
                    if (stat === 'treasury') gameState.escalations.financial = 3;
                    else if (stat === 'resources') gameState.escalations.resources_crisis = 3;
                    else if (stat === 'popular') gameState.escalations.popular = 3;
                    else if (stat === 'noble') gameState.escalations.noble = 3;
                }
            }
            
            // Check stat milestones
            checkStatMilestones();
        }

        function checkStatMilestones() {
            // Don't show milestones on first turn
            if (gameState.eventCount === 0) return;
            
            const milestoneMessages = {
                treasury: "The royal vaults overflow with tribute from loyal vassals!",
                military: "Your armies are the terror of all nations!",
                popular: "The people sing songs of your wisdom and generosity!",
                noble: "The aristocracy proclaims you the greatest of kings!",
                religious: "The priesthood declares the gods favor your reign!",
                resources: "The granaries are full, the forges never cease!",
                egypt: "Pharaoh calls you brother and honored ally!",
                assyria: "Assyria respects your strength and seeks friendship!",
                kassite: "Babylon opens its markets and treasuries to you!"
            };
            
            for (let [stat, value] of Object.entries(gameState.stats)) {
                if (value >= 75 && !gameState.lastMilestones[stat]) {
                    displayMilestoneToast(milestoneMessages[stat]);
                    gameState.lastMilestones[stat] = true;
                } else if (value < 75 && gameState.lastMilestones[stat]) {
                    gameState.lastMilestones[stat] = false;
                }
            }
        }

        function displayMilestoneToast(message) {
            const toast = document.createElement('div');
            toast.className = 'milestone-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function updateAdvisorPortraits() {
            const advisors = {
                hattusili: { icon: "‚öîÔ∏è", name: "Hattusili", title: "General" },
                puduhepa: { icon: "‚õ™", name: "Puduhepa", title: "High Priestess" },
                zida: { icon: "üïµÔ∏è", name: "Zida", title: "Spymaster" },
                kantuzzili: { icon: "üí∞", name: "Kantuzzili", title: "Treasurer" }
            };
            
            let advisorsHTML = '';
            for (let [key, advisor] of Object.entries(advisors)) {
                const loyalty = gameState.advisorLoyalty[key];
                let loyaltyClass = 'loyal-50';
                let statusText = 'Loyal';
                
                if (loyalty >= 75) {
                    loyaltyClass = 'loyal-100';
                    statusText = 'Fiercely Loyal';
                } else if (loyalty >= 50) {
                    loyaltyClass = 'loyal-75';
                    statusText = 'Loyal';
                } else if (loyalty >= 25) {
                    loyaltyClass = 'loyal-25';
                    statusText = 'Uncertain';
                } else if (loyalty >= 10) {
                    loyaltyClass = 'loyal-10';
                    statusText = 'Disloyal';
                } else {
                    loyaltyClass = 'loyal-0';
                    statusText = 'Betraying';
                }
                
                advisorsHTML += `
                    <div class="advisor-card ${loyaltyClass}">
                        <div class="advisor-icon">${advisor.icon}</div>
                        <div class="advisor-name">${advisor.name}</div>
                        <div class="advisor-status">${statusText}</div>
                    </div>
                `;
            }
            
            document.getElementById('advisorsContainer').innerHTML = advisorsHTML;
        }

        // Event System
        function nextEvent() {
            // Prevent double-clicks on Continue button
            if (gameState.isProcessingChoice) {
                return;
            }

            // Check victory condition
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            if (yearsRuled >= gameState.targetYears && gameState.eventCount >= 10) {
                triggerVictory();
                return;
            }
            
            let eventKey = null;
            
            // Priority 1: Queued event
            if (gameState.queuedEvent) {
                eventKey = gameState.queuedEvent;
                gameState.queuedEvent = null;
            }
            // Priority 2: Advisor betrayal warnings
            else {
                for (let [advisor, loyalty] of Object.entries(gameState.advisorLoyalty)) {
                    if (loyalty <= 10 && !gameState.advisorBetrayalWarned[advisor]) {
                        eventKey = `${advisor}_betrayal_warning`;
                        gameState.advisorBetrayalWarned[advisor] = true;
                        break;
                    }
                    if (loyalty <= 0) {
                        eventKey = `${advisor}_betrayal`;
                        break;
                    }
                }
            }
            
            // Priority 3: Escalation events (60% chance if any escalation >= 1)
            if (!eventKey) {
                let activeEscalations = [];
                for (let [escType, level] of Object.entries(gameState.escalations)) {
                    if (level >= 1 && level <= 3) {
                        const escEventKey = `${escType}_stage${level}`;
                        if (!gameState.recentEvents.includes(escEventKey)) {
                            activeEscalations.push(escType);
                        }
                    }
                }
                
                if (activeEscalations.length > 0 && Math.random() < 0.6) {
                    const escType = activeEscalations[Math.floor(Math.random() * activeEscalations.length)];
                    eventKey = `${escType}_stage${gameState.escalations[escType]}`;
                }
            }
            
            // Priority 4: High loyalty advisor events (10% chance)
            if (!eventKey && Math.random() < 0.1) {
                for (let [advisor, loyalty] of Object.entries(gameState.advisorLoyalty)) {
                    if (loyalty >= 85) {
                        const loyalEventKey = `${advisor}_loyal`;
                        if (events[loyalEventKey] && !gameState.recentEvents.includes(loyalEventKey)) {
                            eventKey = loyalEventKey;
                            break;
                        }
                    }
                }
            }
            
            // Priority 5: Random standard event
            if (!eventKey) {
                const availableEvents = Object.keys(events).filter(key => {
                    const event = events[key];
                    // Exclude escalation events, loyalty events, and recently seen events
                    if (key.includes('_stage')) return false;
                    if (key.includes('_betrayal')) return false;
                    if (key.includes('_loyal')) return false;
                    if (gameState.recentEvents.includes(key)) return false;
                    return true;
                });
                
                if (availableEvents.length > 0) {
                    eventKey = availableEvents[Math.floor(Math.random() * availableEvents.length)];
                }
            }
            
            if (eventKey && events[eventKey]) {
                displayEvent(eventKey);
                // Reset processing flag to allow new choices
                gameState.isProcessingChoice = false;
            }
        }

        function displayEvent(eventKey) {
            const event = events[eventKey];
            
            // Add to recent events
            gameState.recentEvents.push(eventKey);
            if (gameState.recentEvents.length > 8) {
                gameState.recentEvents.shift();
            }
            
            let eventHTML = `
                <div class="event-container">
                    <div class="event-header">
                        <div class="event-icon">${event.icon}</div>
                        <h2 class="event-title">${event.title}</h2>
                    </div>
            `;
            
            if (event.image) {
                eventHTML += `<img src="${event.image}" alt="${event.title}" class="event-image">`;
            }
            
            eventHTML += `<div class="event-description">${event.description}</div>`;
            
            // Advisor commentary
            if (event.advisorCommentary && event.advisorCommentary.length > 0) {
                eventHTML += '<div class="commentary-container">';
                for (let comment of event.advisorCommentary) {
                    const advisorNames = {
                        hattusili: "Hattusili",
                        puduhepa: "Puduhepa",
                        zida: "Zida",
                        kantuzzili: "Kantuzzili"
                    };
                    const advisorIcons = {
                        hattusili: "‚öîÔ∏è",
                        puduhepa: "‚õ™",
                        zida: "üïµÔ∏è",
                        kantuzzili: "üí∞"
                    };
                    
                    eventHTML += `
                        <div class="commentary ${comment.mood}">
                            <div class="commentary-header">
                                ${advisorIcons[comment.advisor]} ${advisorNames[comment.advisor]}
                            </div>
                            <div class="commentary-text">${comment.text}</div>
                        </div>
                    `;
                }
                eventHTML += '</div>';
            }
            
            // Choices
            eventHTML += '<div class="choices-container">';
            event.choices.forEach((choice, index) => {
                eventHTML += `
                    <button class="choice-button" onclick="makeChoice('${eventKey}', ${index})">
                        ${choice.text}
                    </button>
                `;
            });
            eventHTML += '</div>';
            
            eventHTML += '</div>';
            
            document.getElementById('eventDisplay').innerHTML = eventHTML;
        }

        function makeChoice(eventKey, choiceIndex) {
            // Prevent double-clicks and re-entry
            if (gameState.isProcessingChoice) {
                return;
            }
            gameState.isProcessingChoice = true;

            // Immediately disable all choice buttons before any other processing
            document.querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);

            playSound('click');
            
            const event = events[eventKey];
            const choice = event.choices[choiceIndex];
            
            // Apply effects
            if (choice.effects) {
                for (let [stat, change] of Object.entries(choice.effects)) {
                    gameState.stats[stat] = Math.max(0, Math.min(100, gameState.stats[stat] + change));
                }
            }
            
            // Apply escalation effects
            if (choice.escalationEffects) {
                for (let [escType, change] of Object.entries(choice.escalationEffects)) {
                    gameState.escalations[escType] = Math.max(0, Math.min(3, gameState.escalations[escType] + change));
                }
            }
            
            // Apply advisor effects with difficulty-based stickiness
            if (choice.advisorEffects) {
                for (let [advisor, change] of Object.entries(choice.advisorEffects)) {
                    let modifiedChange = change;
                    const currentLoyalty = gameState.advisorLoyalty[advisor];
                    
                    // Sticky loyalty for Easy/Medium
                    if (gameState.difficultyMultiplier <= 1.3) {
                        if (change < 0 && currentLoyalty >= 50) {
                            modifiedChange = change * 0.5; // Half penalty when loyal
                        } else if (change > 0 && currentLoyalty < 50) {
                            modifiedChange = change * 1.5; // 50% bonus when recovering
                        }
                    }
                    
                    gameState.advisorLoyalty[advisor] = Math.max(0, Math.min(100, currentLoyalty + modifiedChange));
                }
            }
            
            // Queue event if specified
            if (choice.queuedEvent) {
                gameState.queuedEvent = choice.queuedEvent;
            }
            
            // Check for immediate game over
            if (choice.gameOver) {
                gameOver(choice.gameOver);
                return;
            }
            
            // Update stats display
            updateStats();
            
            // Increment event count
            gameState.eventCount++;
            
            // Advance time (but not on first event)
            advanceTime();
            
            // Display consequences
            displayConsequences(choice);
        }

        function displayConsequences(choice) {
            let consequencesHTML = `
                <div class="consequences-container">
                    <h3 class="consequences-title">‚îÅ‚îÅ‚îÅ Consequences ‚îÅ‚îÅ‚îÅ</h3>
                    <p class="consequence-text">${choice.consequences}</p>
            `;
            
            // Show stat changes
            if (choice.effects) {
                consequencesHTML += '<div class="stat-changes">';
                for (let [stat, change] of Object.entries(choice.effects)) {
                    if (change !== 0) {
                        const statLabels = {
                            treasury: "üí∞ Treasury",
                            military: "‚öîÔ∏è Military",
                            popular: "üë• Popular",
                            noble: "üëë Noble",
                            religious: "‚õ™ Religious",
                            resources: "üåæ Resources",
                            egypt: "üê™ Egypt",
                            assyria: "üèπ Assyria",
                            kassite: "üèõÔ∏è Kassite"
                        };
                        const sign = change > 0 ? '+' : '';
                        const colorClass = change > 0 ? 'positive' : 'negative';
                        consequencesHTML += `
                            <div class="stat-change ${colorClass}">
                                ${statLabels[stat]}: ${sign}${change}
                            </div>
                        `;
                    }
                }
                consequencesHTML += '</div>';
            }
            
            // Show rumors (50% chance, not on first turn, only if significant changes)
            if (gameState.eventCount > 0 && Math.random() < 0.5) {
                const rumors = generateRumors(choice);
                if (rumors.length > 0) {
                    consequencesHTML += `
                        <div class="rumors-container">
                            <div class="rumors-title">Whispers in the Palace:</div>
                            ${rumors.map(r => `<div class="rumor">${r}</div>`).join('')}
                        </div>
                    `;
                }
            }
            
            // Show significant advisor reactions
            if (choice.advisorEffects) {
                let reactions = [];
                for (let [advisor, change] of Object.entries(choice.advisorEffects)) {
                    let modifiedChange = change;
                    const currentLoyalty = gameState.advisorLoyalty[advisor];
                    
                    // Apply same stickiness calculation for display
                    if (gameState.difficultyMultiplier <= 1.3) {
                        if (change < 0 && currentLoyalty >= 50) {
                            modifiedChange = change * 0.5;
                        } else if (change > 0 && currentLoyalty < 50) {
                            modifiedChange = change * 1.5;
                        }
                    }
                    
                    reactions.push({ advisor, change: modifiedChange });
                }
                
                // Sort by absolute value of change
                reactions.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
                
                const advisorNames = {
                    hattusili: "Hattusili",
                    puduhepa: "Puduhepa",
                    zida: "Zida",
                    kantuzzili: "Kantuzzili"
                };
                
                consequencesHTML += '<div class="advisor-reactions">';
                
                let shownReactions = 0;
                for (let reaction of reactions) {
                    const absChange = Math.abs(reaction.change);
                    
                    // Show major approval (15+)
                    if (reaction.change >= 15 && shownReactions < 3) {
                        playSound('approve');
                        const approvalDialogues = getAdvisorApprovalDialogue(reaction.advisor);
                        consequencesHTML += `
                            <div class="advisor-reaction approve">
                                <div class="reaction-header">${advisorNames[reaction.advisor]} approves strongly</div>
                                <div>${approvalDialogues[Math.floor(Math.random() * approvalDialogues.length)]}</div>
                            </div>
                        `;
                        shownReactions++;
                    }
                    // Show major disapproval (20+)
                    else if (reaction.change <= -20 && shownReactions < 3) {
                        playSound('disapprove');
                        const disapprovalDialogues = getAdvisorMajorDisapprovalDialogue(reaction.advisor);
                        consequencesHTML += `
                            <div class="advisor-reaction disapprove">
                                <div class="reaction-header">${advisorNames[reaction.advisor]} strongly disapproves</div>
                                <div>${disapprovalDialogues[Math.floor(Math.random() * disapprovalDialogues.length)]}</div>
                            </div>
                        `;
                        shownReactions++;
                    }
                    // Show moderate disapproval (10-19) only if it's the highest
                    else if (reaction.change <= -10 && shownReactions === 0) {
                        playSound('disapprove');
                        const moderateDialogues = getAdvisorModerateDisapprovalDialogue(reaction.advisor);
                        consequencesHTML += `
                            <div class="advisor-reaction disapprove">
                                <div class="reaction-header">${advisorNames[reaction.advisor]} disapproves</div>
                                <div>${moderateDialogues[Math.floor(Math.random() * moderateDialogues.length)]}</div>
                            </div>
                        `;
                        shownReactions++;
                        break; // Only show one moderate reaction
                    }
                }
                
                consequencesHTML += '</div>';
            }
            
            consequencesHTML += `
                <div style="text-align: center; margin-top: 25px;">
                    <button class="button" onclick="nextEvent()">Continue</button>
                </div>
            </div>
            `;

            // Append to event display (using insertAdjacentHTML to avoid re-parsing)
            document.getElementById('eventDisplay').insertAdjacentHTML('beforeend', consequencesHTML);
        }

        function generateRumors(choice) {
            const rumors = [];
            const rumorPools = {
                military: [
                    "The chariotry captain claims this rivals the tactics of Tuthmosis III himself.",
                    "Veterans of the Mitanni campaigns nod approvingly - they've seen worse kings make worse choices.",
                    "A Luwian mercenary was overheard saying 'Now THAT is a war-leader' in the barracks.",
                    "The armorer swears he'll name his next sword after this decision."
                ],
                treasury: [
                    "Silver shekels are already flowing differently through the karum - the merchant quarter buzzes.",
                    "A Phoenician trader offers 3-to-1 odds the treasury doubles within a year.",
                    "The guild of scribes worked past midnight recalculating the tribute from Arzawa.",
                    "Even ≈†arruma the moneylender - who trusts no one - seems impressed."
                ],
                popular: [
                    "The grain-women at the market are singing a new song about you. It actually rhymes.",
                    "Old Piyassili the potter - who hasn't smiled in thirty years - cracked a grin at his wheel.",
                    "Three taverns in the lower city are offering free beer to toast the king's wisdom.",
                    "My servant girl swears her grandmother wept with joy. She's ninety and remembers bad kings."
                ],
                religious: [
                    "The Oracle of the Storm God spoke three words after a week of silence: 'The King Understands.'",
                    "Priests at the Sun Goddess temple lit spontaneous offerings - they never do that.",
                    "A Hurrian priestess claims she saw the sacred eagle circle the palace seven times at dawn.",
                    "The Chief Augur examined sheep livers for three hours and emerged smiling. That's... unprecedented."
                ],
                noble: [
                    "House Piyama-Radu sent a golden cup to the palace with your seal engraved on it.",
                    "The Lady Tanuhepa - known for her sharp tongue - called you 'almost wise as your father.' High praise from her.",
                    "Young nobles at the archery grounds are imitating your supposed words. Badly, but still.",
                    "Even Telipinu the Grumpy - who opposed your coronation - was heard muttering '...perhaps I was wrong.'"
                ],
                resources: [
                    "The granaries at Nerik report stores sufficient for two years. Two years!",
                    "Cypriot copper traders are already negotiating next year's contracts at better rates.",
                    "A merchant caravan from Ugarit changed course mid-journey to bring goods HERE instead of Assur.",
                    "The chief baker used the phrase 'swimming in grain.' He's not a poetic man - he means it literally."
                ],
                egypt: [
                    "Pharaoh's ambassador was seen actually smiling. Egyptians never smile. What did you do?",
                    "A messenger boat is racing down the Orontes toward the Egyptian delta at ramming speed.",
                    "The Egyptian scribe made copies of the decision in hieratic script - they're keeping records.",
                    "Word is Memphis is preparing either a celebration or an assassination. Possibly both."
                ],
                assyria: [
                    "Assyrian merchants suddenly want to pay their customs fees in advance. They NEVER do that.",
                    "A cuneiform tablet found its way to the Assyrian trade house. Someone read it and went pale.",
                    "The Assyrian ambassador requested an audience, was denied, requested again, and is now pacing frantically.",
                    "Traders from Assur are hedging their bets - some backing you, some backing away entirely."
                ],
                kassite: [
                    "A Babylonian astrologer-priest claims this decision aligns with the star Ishtar. He's usually wrong, but...",
                    "The Kassite delegation sent a messenger via the Euphrates route - faster than land. They're in a hurry.",
                    "A cylinder seal from Babylon arrived with a cryptic message: 'The old king remembers.' What does THAT mean?",
                    "Babylonian merchants are recalculating their entire seasonal trade strategy. You've disrupted their cosmos."
                ]
            };
            
            // Check for significant stat changes (15+)
            if (choice.effects) {
                for (let [stat, change] of Object.entries(choice.effects)) {
                    if (Math.abs(change) >= 15) {
                        let category = stat;
                        if (rumorPools[category]) {
                            rumors.push(rumorPools[category][Math.floor(Math.random() * rumorPools[category].length)]);
                        }
                    }
                }
            }
            
            // Check for significant advisor reactions (15+)
            if (choice.advisorEffects) {
                for (let [advisor, change] of Object.entries(choice.advisorEffects)) {
                    if (Math.abs(change) >= 15) {
                        const advisorNames = {
                            hattusili: 'the general',
                            puduhepa: 'the high priestess',
                            zida: 'the spymaster',
                            kantuzzili: 'the treasurer'
                        };
                        const advisorRumors = [
                            `They say ${advisorNames[advisor]} ${change > 0 ? 'smiled broadly' : 'stormed from the council chamber'} after hearing of this.`,
                            `A servant swears ${advisorNames[advisor]} was ${change > 0 ? 'in excellent spirits' : 'muttering darkly'} all evening.`,
                            `Palace guards report ${advisorNames[advisor]} ${change > 0 ? 'seemed quite pleased' : 'looked most displeased'} with the decision.`
                        ];
                        rumors.push(advisorRumors[Math.floor(Math.random() * advisorRumors.length)]);
                    }
                }
            }
            
            // Return 1-2 most interesting unique rumors
            const uniqueRumors = [...new Set(rumors)];
            const count = uniqueRumors.length > 1 ? (Math.random() < 0.5 ? 2 : 1) : uniqueRumors.length;
            return uniqueRumors.slice(0, count);
        }

        // Advisor reaction dialogue generators
        function getAdvisorApprovalDialogue(advisor) {
            const dialogues = {
                hattusili: [
                    "Now THIS is leadership! The army stands ready to follow such a king!",
                    "Excellent decision, my lord! Your enemies will tremble at such resolve!",
                    "The troops will sing of this day! You have my sword, always!"
                ],
                puduhepa: [
                    "The gods smile upon this choice. You honor them with your wisdom.",
                    "This is the path of righteousness. The Storm God is pleased.",
                    "You have shown the wisdom the gods demand of kings. Well done."
                ],
                zida: [
                    "Brilliant, my lord. You saw through the deception where others would have stumbled.",
                    "This is precisely the sort of strategic thinking that keeps kingdoms alive.",
                    "My agents will spread word of your cunning. Your enemies should worry."
                ],
                kantuzzili: [
                    "A fiscally sound decision! The treasury thanks you, my lord!",
                    "Finally, someone who understands that gold spent wisely is worth more than gold spent foolishly!",
                    "The royal accounts will reflect this wisdom. Excellent choice!"
                ]
            };
            return dialogues[advisor] || ["Your advisor approves of this decision."];
        }

        function getAdvisorModerateDisapprovalDialogue(advisor) {
            const dialogues = {
                hattusili: [
                    "I... must voice my concerns about this decision, my lord. The army may not understand.",
                    "With respect, this seems like a missed opportunity to show strength.",
                    "I pray you know what you are doing, my lord. The troops expected more."
                ],
                puduhepa: [
                    "I am troubled by this choice. The gods may not look favorably upon it.",
                    "This path concerns me, my lord. Have you considered the spiritual implications?",
                    "I will pray that the gods forgive this decision."
                ],
                zida: [
                    "A risky move, my lord. I hope you have seen something my agents have not.",
                    "I must counsel caution. This decision opens us to danger.",
                    "My lord, I fear you may regret this choice."
                ],
                kantuzzili: [
                    "The treasury will feel this decision, my lord. I hope the cost is worth it.",
                    "I must note my objection. This is not the most prudent use of resources.",
                    "With respect, my lord, there were more economical options."
                ]
            };
            return dialogues[advisor] || ["Your advisor has concerns about this decision."];
        }

        function getAdvisorMajorDisapprovalDialogue(advisor) {
            const dialogues = {
                hattusili: [
                    "This is madness! The army will not stand for such weakness! I cannot support this!",
                    "My lord, you court disaster! The soldiers will question your leadership after this!",
                    "I must speak plainly - this decision dishonors everything we fight for!"
                ],
                puduhepa: [
                    "The gods will judge you harshly for this! This is an affront to everything sacred!",
                    "I am shocked and dismayed! How can you expect the divine blessing after this choice?",
                    "This is sacrilege! The priesthood cannot support such impiety!"
                ],
                zida: [
                    "You have walked directly into the trap I warned you about! This is catastrophic!",
                    "My lord, you have just made a terrible, perhaps fatal, error in judgment!",
                    "Against all counsel, you chose the worst possible path! I fear for the kingdom!"
                ],
                kantuzzili: [
                    "This will bankrupt us! How can you spend gold we do not have?!",
                    "Ruin! You have chosen financial ruin! The treasury cannot sustain this madness!",
                    "I cannot, in good conscience, approve these accounts! This is fiscal insanity!"
                ]
            };
            return dialogues[advisor] || ["Your advisor strongly opposes this decision!"];
        }

        // Victory System
        function checkVictoryCondition() {
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            return yearsRuled >= gameState.targetYears && gameState.eventCount >= 10;
        }

        function triggerVictory() {
            playSound('victory');
            
            const king = kingData[gameState.selectedKing];
            const score = calculateScore();
            const breakdown = getScoreBreakdown();
            
            let victoryHTML = `
                <img src="hittite_king.png" alt="${king.name}">
                <h1 class="victory-title">‚ïê‚ïê‚ïê VICTORY: A PEACEFUL DEATH ‚ïê‚ïê‚ïê</h1>
                <div class="victory-narrative">${king.victoryNarrative}</div>
                
                <div class="accomplishments">
                    <h3>Your Reign Saw:</h3>
                    ${generateAccomplishments()}
                </div>
                
                <div class="accomplishments">
                    <h3>Your Advisors Remember:</h3>
                    ${generateAdvisorTestimonials()}
                </div>
                
                <div class="accomplishments">
                    <h3>Your Legacy:</h3>
                    <p>${determineLegacy(score)}</p>
                </div>
                
                <div class="score-breakdown">
                    <h3>Final Score: ${Math.round(score)}</h3>
                    ${breakdown}
                </div>
            `;
            
            // Check leaderboard placement
            const placement = checkLeaderboardPlacement(score);
            if (placement > 0) {
                victoryHTML += `
                    <div class="high-score-celebration">
                        üèÜ NEW HIGH SCORE! üèÜ<br>
                        You placed #${placement} on the Hall of Kings!
                    </div>
                `;
                saveToLeaderboard(king.name, score, Math.floor(gameState.currentYear - gameState.startYear));
            }
            
            document.getElementById('victoryContent').innerHTML = victoryHTML;
            showScreen('victoryScreen');
        }

        function calculateScore() {
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            
            // Base score components
            let score = 0;
            score += yearsRuled * 10; // Reign length
            
            // Average stats
            const statValues = Object.values(gameState.stats);
            const avgStats = statValues.reduce((a, b) => a + b, 0) / statValues.length;
            score += avgStats * 5;
            
            // Average advisor loyalty
            const loyaltyValues = Object.values(gameState.advisorLoyalty);
            const avgLoyalty = loyaltyValues.reduce((a, b) => a + b, 0) / loyaltyValues.length;
            score += avgLoyalty * 3;
            
            // Peace bonus
            if (gameState.stats.egypt >= 50 && gameState.stats.assyria >= 50 && gameState.stats.kassite >= 50) {
                score += 200;
            }
            
            // Prosperity bonus
            if (gameState.stats.treasury >= 60 && gameState.stats.resources >= 60 && gameState.stats.popular >= 60) {
                score += 200;
            }
            
            // Penalties
            for (let [stat, value] of Object.entries(gameState.stats)) {
                if (value < 25) score -= 50;
            }
            
            for (let [advisor, loyalty] of Object.entries(gameState.advisorLoyalty)) {
                if (loyalty < 50) score -= 30;
            }
            
            for (let [escType, level] of Object.entries(gameState.escalations)) {
                if (level >= 2) score -= 100;
            }
            
            // Difficulty multiplier
            score *= gameState.difficultyMultiplier;
            
            return Math.max(0, score);
        }

        function getScoreBreakdown() {
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            const statValues = Object.values(gameState.stats);
            const avgStats = statValues.reduce((a, b) => a + b, 0) / statValues.length;
            const loyaltyValues = Object.values(gameState.advisorLoyalty);
            const avgLoyalty = loyaltyValues.reduce((a, b) => a + b, 0) / loyaltyValues.length;
            
            const peaceBonus = (gameState.stats.egypt >= 50 && gameState.stats.assyria >= 50 && gameState.stats.kassite >= 50) ? 200 : 0;
            const prosperityBonus = (gameState.stats.treasury >= 60 && gameState.stats.resources >= 60 && gameState.stats.popular >= 60) ? 200 : 0;
            
            let penalties = 0;
            for (let value of statValues) {
                if (value < 25) penalties -= 50;
            }
            for (let loyalty of loyaltyValues) {
                if (loyalty < 50) penalties -= 30;
            }
            for (let level of Object.values(gameState.escalations)) {
                if (level >= 2) penalties -= 100;
            }
            
            const baseScore = (yearsRuled * 10) + (avgStats * 5) + (avgLoyalty * 3) + peaceBonus + prosperityBonus + penalties;
            const finalScore = baseScore * gameState.difficultyMultiplier;
            
            return `
                <div class="score-line">Reign Length: ${yearsRuled} years √ó 10 = ${yearsRuled * 10}</div>
                <div class="score-line">Average Stats: ${avgStats.toFixed(1)} √ó 5 = ${(avgStats * 5).toFixed(0)}</div>
                <div class="score-line">Average Advisor Loyalty: ${avgLoyalty.toFixed(1)} √ó 3 = ${(avgLoyalty * 3).toFixed(0)}</div>
                <div class="score-line">Peace Bonus: ${peaceBonus}</div>
                <div class="score-line">Prosperity Bonus: ${prosperityBonus}</div>
                <div class="score-line">Penalties: ${penalties}</div>
                <div class="score-line">Base Score: ${baseScore.toFixed(0)}</div>
                <div class="score-line">Difficulty Multiplier: √ó${gameState.difficultyMultiplier}</div>
                <div class="score-line total">FINAL SCORE: ${Math.round(finalScore)}</div>
            `;
        }

        function generateAccomplishments() {
            let accomplishments = [];
            
            if (gameState.stats.military > 70) accomplishments.push("A mighty military that struck fear into all enemies");
            if (gameState.stats.treasury > 70) accomplishments.push("Vast wealth accumulated through wise stewardship");
            if (gameState.stats.popular > 70) accomplishments.push("The enduring love and loyalty of your people");
            if (gameState.stats.religious > 70) accomplishments.push("The favor of the gods and the priesthood's blessing");
            if (gameState.stats.egypt >= 60 && gameState.stats.assyria >= 60 && gameState.stats.kassite >= 60) {
                accomplishments.push("Peace and good relations with all major powers");
            }
            
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            accomplishments.push(`A reign of ${yearsRuled} years - a full generation of rule`);
            
            if (accomplishments.length === 0) {
                accomplishments.push("Survival against all odds");
            }
            
            return '<ul>' + accomplishments.map(a => `<li>${a}</li>`).join('') + '</ul>';
        }

        function generateAdvisorTestimonials() {
            let testimonials = [];
            
            for (let [advisor, loyalty] of Object.entries(gameState.advisorLoyalty)) {
                const names = {
                    hattusili: "General Hattusili",
                    puduhepa: "High Priestess Puduhepa",
                    zida: "Spymaster Zida",
                    kantuzzili: "Treasurer Kantuzzili"
                };
                
                let quote = "";
                if (loyalty >= 75) {
                    const quotes = {
                        hattusili: "served the greatest king I ever knew. I would have died for such a leader.",
                        puduhepa: "was blessed by the gods. The Storm God favored this reign.",
                        zida: "saw through every deception and navigated every danger with wisdom.",
                        kantuzzili: "understood that a kingdom's strength lies in its treasury and trade."
                    };
                    quote = `"I ${quotes[advisor]}"`;
                } else if (loyalty >= 50) {
                    quote = '"A capable ruler who did what was necessary."';
                } else {
                    quote = '"The reign had... challenges. But we survived."';
                }
                
                testimonials.push(`<strong>${names[advisor]}</strong>: ${quote}`);
            }
            
            return '<ul>' + testimonials.map(t => `<li>${t}</li>`).join('') + '</ul>';
        }

        function determineLegacy(score) {
            if (score >= 10000) {
                return "The chronicles will remember you as one of the greatest kings in Hittite history. Songs will be sung of your reign for a thousand years.";
            } else if (score >= 7000) {
                return "You will be remembered as a great king who led Hatti through difficult times with wisdom and strength.";
            } else if (score >= 5000) {
                return "You will be remembered as a capable king who preserved the kingdom and did his duty.";
            } else if (score >= 3000) {
                return "You will be remembered as a king who faced great challenges and survived to die in peace.";
            } else {
                return "You will be remembered as a king who endured. Survival itself is no small achievement.";
            }
        }

        // Game Over System
        function gameOver(reason) {
            const gameOverNarratives = {
                treasury: "The royal treasury stands empty. Your creditors circle like vultures. The army has not been paid in months. Your nobles abandon you. Foreign powers sense weakness. Unable to pay your debts or defend your borders, you are forced to abdicate in disgrace. The chroniclers will record that you were a king who could not manage his kingdom's wealth.",
                
                military: "Your army has collapsed. The soldiers desert or defect. The borders lie undefended. Enemy forces pour into Hatti like water through broken dam. Hattusa itself falls to foreign conquest. As you flee through secret passages with what remains of your family, you hear the war cries of those who have destroyed your kingdom. You die in exile, a king without a kingdom.",
                
                popular: "The people have had enough. What begins as protests becomes riot, becomes revolution, becomes your death. The mob storms the palace. Your guards cannot hold them back - many join the rebellion. You are dragged from your throne room and subjected to the fury of those you failed to protect. The chronicles will record that you were overthrown by your own subjects.",
                
                noble: "The great noble families have united against you. In a carefully orchestrated coup, the aristocracy strips you of power. You are declared unfit to rule and placed under house arrest. A new king, chosen by the nobles, takes your throne. You spend the rest of your days in comfortable imprisonment, a living reminder that in Hatti, the nobility can break kings who lose their support.",
                
                religious: "The priesthood has turned against you. They declare that the Storm God has withdrawn his favor. The people believe them. Your religious authority crumbles. Desperate to restore divine blessing, you submit to the priesthood's demands, but they declare you permanently unfit to rule in the gods' name. You abdicate and enter the temple as a penitent. You live, but your reign is over.",
                
                resources: "Famine consumes the kingdom. The people starve. Disease follows hunger. The cities empty as desperate families flee to wherever food can be found. Your kingdom collapses not through conquest but through slow starvation. In the end, you rule over a land of ghosts. Even you cannot escape the hunger. You die of starvation in your own palace, surrounded by empty granaries.",
                
                egypt: "Egypt has had enough of your insults and provocations. Pharaoh's armies march north in terrible fury. The Egyptian war machine is unstoppable. Your forces are crushed in a series of devastating defeats. Egyptian chariots thunder through Hattusa's streets. You are captured and dragged to Egypt in chains, to be displayed as a trophy of Pharaoh's victory. You die in Egyptian captivity, far from home.",
                
                assyria: "Assyria strikes with overwhelming force. Their armies, seeing your weakness, pour across the border. The Assyrian war cry echoes through Hittite lands. City after city falls. Hattusa is besieged, starved, and finally stormed. You die fighting on the palace walls as Assyrian soldiers pour through the breach. At least you fell with a sword in your hand.",
                
                kassite: "Your hostility with Babylon has created a coalition of enemies. The Kassites convince Egypt and Assyria to join them in destroying Hatti. You face a three-front war you cannot possibly win. Surrounded and outnumbered, your kingdom is carved up between the victorious powers. You are hunted down and executed as a war criminal. The Hittite Empire ceases to exist.",
                
                abdication: "You step down from the throne, ending your reign without bloodshed. Hattusili accepts the crown from your hands. As you leave the palace for the last time, you wonder if you could have made different choices. You will live out your days in quiet exile, a king who gave up his throne rather than fight for it.",
                
                military_defeat: "You fought bravely but you were outnumbered. The palace falls. You die defending your throne, sword in hand. At least you died as a warrior-king should. The chroniclers will note that you refused to surrender. That counts for something.",
                
                captured: "Your escape attempt fails. You are taken prisoner while trying to reach loyalist forces. Your captors show no mercy. A king without a kingdom is nothing. You are imprisoned and die in captivity, dreaming of what might have been.",
                
                religious_condemnation: "Unable to withstand the priesthood's condemnation, you perform elaborate public penance. But the damage is done. Your authority is broken. You abdicate in favor of a more 'godly' successor. You retire to a remote temple, your reign remembered as one that lost the gods' favor.",
                
                popular_revolt: "Your suppression of the priesthood backfires spectacularly. The people view it as blasphemy. Riots sweep through every city. Your reign collapses in chaos and violence. You are overthrown and exiled, remembered as the king who made war on the gods."
            };
            
            const narrative = gameOverNarratives[reason] || "Your reign has ended in failure. The kingdom falls into chaos.";
            const yearsRuled = Math.floor(gameState.currentYear - gameState.startYear);
            
            document.getElementById('gameOverContent').innerHTML = `
                <img src="game_over.png" alt="Game Over">
                <h1 class="game-over-title">THE STORM GOD HAS FORSAKEN YOU</h1>
                <div class="game-over-narrative">${narrative}</div>
                <div style="text-align: center; margin: 30px 0; font-size: 1.2em;">
                    <strong>You ruled for ${yearsRuled} years (${Math.floor(gameState.startYear)} - ${Math.floor(gameState.currentYear)} BCE)</strong>
                </div>
            `;
            
            showScreen('gameOverScreen');
        }

        // Leaderboard System
        function saveToLeaderboard(kingName, score, years) {
            let leaderboard = loadLeaderboard();
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            
            leaderboard.push({
                king: kingName,
                score: Math.round(score),
                years: years,
                date: dateStr
            });
            
            // Sort by score descending
            leaderboard.sort((a, b) => b.score - a.score);
            
            // Keep only top 10
            leaderboard = leaderboard.slice(0, 10);
            
            localStorage.setItem('hittite_leaderboard', JSON.stringify(leaderboard));
        }

        function loadLeaderboard() {
            const data = localStorage.getItem('hittite_leaderboard');
            return data ? JSON.parse(data) : [];
        }

        function showLeaderboard() {
            playSound('click');
            const leaderboard = loadLeaderboard();
            
            let tableHTML = '';
            if (leaderboard.length === 0) {
                tableHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No scores yet. Be the first to complete a reign!</td></tr>';
            } else {
                leaderboard.forEach((entry, index) => {
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                    tableHTML += `
                        <tr class="${rankClass}">
                            <td>#${index + 1}</td>
                            <td>${entry.king}</td>
                            <td>${entry.score}</td>
                            <td>${entry.years}</td>
                            <td>${entry.date}</td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('leaderboardBody').innerHTML = tableHTML;
            showScreen('leaderboardScreen');
        }

        function checkLeaderboardPlacement(score) {
            const leaderboard = loadLeaderboard();
            
            // If less than 10 entries, automatically qualifies
            if (leaderboard.length < 10) {
                return leaderboard.length + 1;
            }
            
            // Check if score beats any current entry
            for (let i = 0; i < leaderboard.length; i++) {
                if (score > leaderboard[i].score) {
                    return i + 1;
                }
            }
            
            return 0; // Didn't place
        }

        function clearLeaderboard() {
            if (confirm('Are you sure you want to clear the Hall of Kings? This cannot be undone.')) {
                localStorage.removeItem('hittite_leaderboard');
                showLeaderboard();
                playSound('whoosh');
            }
        }

        // Initialize
        window.onload = function() {
            updateTimeDisplay();
        };
    </script>
</body>
</html>